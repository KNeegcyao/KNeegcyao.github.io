<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>SpringSecurityæ¡†æ¶å…¥é—¨ | KNeegcyao</title><meta name="author" content="KNeegcyao"><meta name="copyright" content="KNeegcyao"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="ç®€ä»‹å®˜ç½‘ Spring Securityæ˜¯ä¸€ä¸ªJavaæ¡†æ¶ï¼Œç”¨äºä¿æŠ¤åº”ç”¨ç¨‹åºçš„å®‰å…¨æ€§ã€‚å®ƒæä¾›äº†ä¸€å¥—å…¨é¢çš„å®‰å…¨è§£å†³æ–¹æ¡ˆï¼ŒåŒ…æ‹¬èº«ä»½éªŒè¯ã€æˆæƒã€é˜²æ­¢æ”»å‡»ç­‰åŠŸèƒ½ã€‚Spring SecurityåŸºäºè¿‡æ»¤å™¨é“¾çš„æ¦‚å¿µï¼Œå¯ä»¥è½»æ¾åœ°é›†æˆåˆ°ä»»ä½•åŸºäºSpringçš„åº”ç”¨ç¨‹åºä¸­ã€‚å®ƒæ”¯æŒå¤šç§èº«ä»½éªŒè¯é€‰é¡¹å’Œæˆæƒç­–ç•¥ï¼Œå¼€å‘äººå‘˜å¯ä»¥æ ¹æ®éœ€è¦é€‰æ‹©é€‚åˆçš„æ–¹å¼ã€‚æ­¤å¤–ï¼ŒSpring Securityè¿˜æä¾›äº†ä¸€äº›é™„åŠ åŠŸèƒ½ï¼Œå¦‚é›†æˆç¬¬ä¸‰æ–¹èº«ä»½éªŒ">
<meta property="og:type" content="article">
<meta property="og:title" content="SpringSecurityæ¡†æ¶å…¥é—¨">
<meta property="og:url" content="http://example.com/posts/581c43cc.html">
<meta property="og:site_name" content="KNeegcyao">
<meta property="og:description" content="ç®€ä»‹å®˜ç½‘ Spring Securityæ˜¯ä¸€ä¸ªJavaæ¡†æ¶ï¼Œç”¨äºä¿æŠ¤åº”ç”¨ç¨‹åºçš„å®‰å…¨æ€§ã€‚å®ƒæä¾›äº†ä¸€å¥—å…¨é¢çš„å®‰å…¨è§£å†³æ–¹æ¡ˆï¼ŒåŒ…æ‹¬èº«ä»½éªŒè¯ã€æˆæƒã€é˜²æ­¢æ”»å‡»ç­‰åŠŸèƒ½ã€‚Spring SecurityåŸºäºè¿‡æ»¤å™¨é“¾çš„æ¦‚å¿µï¼Œå¯ä»¥è½»æ¾åœ°é›†æˆåˆ°ä»»ä½•åŸºäºSpringçš„åº”ç”¨ç¨‹åºä¸­ã€‚å®ƒæ”¯æŒå¤šç§èº«ä»½éªŒè¯é€‰é¡¹å’Œæˆæƒç­–ç•¥ï¼Œå¼€å‘äººå‘˜å¯ä»¥æ ¹æ®éœ€è¦é€‰æ‹©é€‚åˆçš„æ–¹å¼ã€‚æ­¤å¤–ï¼ŒSpring Securityè¿˜æä¾›äº†ä¸€äº›é™„åŠ åŠŸèƒ½ï¼Œå¦‚é›†æˆç¬¬ä¸‰æ–¹èº«ä»½éªŒ">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/KNeegcyao/picdemo/img/springsecurity-1024x538-1.jpg">
<meta property="article:published_time" content="2025-04-06T08:19:43.000Z">
<meta property="article:modified_time" content="2025-05-29T02:22:53.344Z">
<meta property="article:author" content="KNeegcyao">
<meta property="article:tag" content="ç®—æ³•">
<meta property="article:tag" content="SpringCloud">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/KNeegcyao/picdemo/img/springsecurity-1024x538-1.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/posts/581c43cc.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"ç¹","msgToSimplifiedChinese":"ç°¡"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":true},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶å¤±è´¥',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: undefined,
  lightbox: '//github.com/francoischalifour/medium-zoom',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'åŠ è½½æ›´å¤š'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'SpringSecurityæ¡†æ¶å…¥é—¨',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  isShuoshuo: false
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="web_bg" style="background-image: url(https://haowallpaper.com/link/common/file/previewFileImg/15189043253972288);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="https://cdn.jsdelivr.net/gh/KNeegcyao/picdemo/img/dbec14fc4bb3795ba2556e8a82eaee0f.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">25</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">8</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">6</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> ä¸»é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> æ ‡ç­¾</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> åˆ†ç±»</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> é“¾æ¥</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> å‹æƒ…é“¾æ¥</span></a></li><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-heart"></i><span> å…³äº</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://haowallpaper.com/link/common/file/previewFileImg/15918089447001472);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src="https://cdn.jsdelivr.net/gh/KNeegcyao/picdemo/img/dbec14fc4bb3795ba2556e8a82eaee0f.jpg" alt="Logo"><span class="site-name">KNeegcyao</span></a><a class="nav-page-title" href="/"><span class="site-name">SpringSecurityæ¡†æ¶å…¥é—¨</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> ä¸»é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> æ ‡ç­¾</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> åˆ†ç±»</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> é“¾æ¥</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> å‹æƒ…é“¾æ¥</span></a></li><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-heart"></i><span> å…³äº</span></a></li></ul></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">SpringSecurityæ¡†æ¶å…¥é—¨</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">å‘è¡¨äº</span><time class="post-meta-date-created" datetime="2025-04-06T08:19:43.000Z" title="å‘è¡¨äº 2025-04-06 16:19:43">2025-04-06</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2025-05-29T02:22:53.344Z" title="æ›´æ–°äº 2025-05-29 10:22:53">2025-05-29</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%90%8E%E7%AB%AF%E6%A1%86%E6%9E%B6/">åç«¯æ¡†æ¶</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">æ€»å­—æ•°:</span><span class="word-count">7.9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»æ—¶é•¿:</span><span>30åˆ†é’Ÿ</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">æµè§ˆé‡:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">è¯„è®ºæ•°:</span><a href="/posts/581c43cc.html#post-comment"><span class="gitalk-comment-count"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h1><p><a target="_blank" rel="noopener" href="https://spring.io/projects/spring-security">å®˜ç½‘</a></p>
<p>Spring Securityæ˜¯ä¸€ä¸ªJavaæ¡†æ¶ï¼Œç”¨äºä¿æŠ¤åº”ç”¨ç¨‹åºçš„å®‰å…¨æ€§ã€‚å®ƒæä¾›äº†ä¸€å¥—å…¨é¢çš„å®‰å…¨è§£å†³æ–¹æ¡ˆï¼ŒåŒ…æ‹¬èº«ä»½éªŒè¯ã€æˆæƒã€é˜²æ­¢æ”»å‡»ç­‰åŠŸèƒ½ã€‚Spring SecurityåŸºäºè¿‡æ»¤å™¨é“¾çš„æ¦‚å¿µï¼Œå¯ä»¥è½»æ¾åœ°é›†æˆåˆ°ä»»ä½•åŸºäºSpringçš„åº”ç”¨ç¨‹åºä¸­ã€‚å®ƒæ”¯æŒå¤šç§èº«ä»½éªŒè¯é€‰é¡¹å’Œæˆæƒç­–ç•¥ï¼Œå¼€å‘äººå‘˜å¯ä»¥æ ¹æ®éœ€è¦é€‰æ‹©é€‚åˆçš„æ–¹å¼ã€‚æ­¤å¤–ï¼ŒSpring Securityè¿˜æä¾›äº†ä¸€äº›é™„åŠ åŠŸèƒ½ï¼Œå¦‚é›†æˆç¬¬ä¸‰æ–¹èº«ä»½éªŒè¯æä¾›å•†å’Œå•ç‚¹ç™»å½•ï¼Œä»¥åŠä¼šè¯ç®¡ç†å’Œå¯†ç ç¼–ç ç­‰ã€‚æ€»ä¹‹ï¼ŒSpring Securityæ˜¯ä¸€ä¸ªå¼ºå¤§ä¸”æ˜“äºä½¿ç”¨çš„æ¡†æ¶ï¼Œå¯ä»¥å¸®åŠ©å¼€å‘äººå‘˜æé«˜åº”ç”¨ç¨‹åºçš„å®‰å…¨æ€§å’Œå¯é æ€§ã€‚</p>
<p><strong>ğŸ‘‰ğŸ»<a target="_blank" rel="noopener" href="https://github.com/KNeegcyao/My-SpringSecurity">ç¤ºä¾‹ä»£ç åœ°å€</a></strong></p>
<p><em><strong>ä¸»è¦åŠŸèƒ½ï¼š</strong></em><br><strong>1. è®¤è¯ï¼ˆAuthenticationï¼‰</strong></p>
<ul>
<li><strong>ç”¨æˆ·èº«ä»½éªŒè¯</strong>ï¼šSpring Security é€šè¿‡å¤šç§æ–¹å¼ï¼ˆå¦‚è¡¨å•ç™»å½•ã€HTTP Basicã€OAuth2 ç­‰ï¼‰éªŒè¯ç”¨æˆ·èº«ä»½ï¼Œç¡®ä¿åªæœ‰åˆæ³•ç”¨æˆ·èƒ½å¤Ÿè®¿é—®ç³»ç»Ÿã€‚</li>
<li><strong>çµæ´»çš„è®¤è¯æœºåˆ¶</strong>ï¼šæ”¯æŒè‡ªå®šä¹‰è®¤è¯æµç¨‹å’Œæä¾›è€…ï¼Œä¾¿äºä¸å„ç§èº«ä»½éªŒè¯æ–¹æ¡ˆé›†æˆã€‚</li>
</ul>
<p><strong>2. æˆæƒï¼ˆAuthorizationï¼‰</strong></p>
<ul>
<li><strong>è®¿é—®æ§åˆ¶</strong>ï¼šåœ¨ç”¨æˆ·é€šè¿‡è®¤è¯åï¼ŒSpring Security æ ¹æ®é…ç½®çš„æƒé™è§„åˆ™ï¼ˆå¦‚è§’è‰²ã€æƒé™ç­‰ï¼‰æ§åˆ¶ç”¨æˆ·å¯¹èµ„æºçš„è®¿é—®ã€‚</li>
<li><strong>æ–¹æ³•çº§å®‰å…¨</strong>ï¼šé€šè¿‡æ³¨è§£ï¼ˆä¾‹å¦‚ <code>@PreAuthorize</code>ã€<code>@Secured</code> ç­‰ï¼‰å¯ä»¥åœ¨ä¸šåŠ¡é€»è¾‘å±‚é¢ç›´æ¥æ§åˆ¶è®¿é—®æƒé™ï¼Œå®ç°ç»†ç²’åº¦çš„æƒé™ç®¡ç†ã€‚</li>
</ul>
<p><strong>3. é˜²å¾¡å¸¸è§æ”»å‡»</strong></p>
<ul>
<li><strong>CSRF æ”»å‡»é˜²æŠ¤</strong>ï¼šå†…ç½®è·¨ç«™è¯·æ±‚ä¼ªé€ ï¼ˆCSRFï¼‰é˜²æŠ¤æœºåˆ¶ï¼Œæœ‰æ•ˆé™ä½æ”»å‡»é£é™©ã€‚</li>
<li><strong>ä¼šè¯ç®¡ç†</strong>ï¼šæä¾›ä¼šè¯å›ºå®šæ”»å‡»é˜²æŠ¤ã€å¹¶å‘ç™»å½•æ§åˆ¶ç­‰åŠŸèƒ½ï¼Œä¿éšœä¼šè¯å®‰å…¨ã€‚</li>
<li><strong>å®‰å…¨å¤´è®¾ç½®</strong>ï¼šè‡ªåŠ¨é…ç½® HTTP å®‰å…¨å¤´ï¼ˆå¦‚ X-Frame-Optionsã€X-XSS-Protection ç­‰ï¼‰æ¥å¢å¼ºå®‰å…¨æ€§ã€‚</li>
</ul>
<p><strong>4. å¯æ‰©å±•æ€§ä¸å®šåˆ¶åŒ–</strong></p>
<ul>
<li><strong>é«˜åº¦å®šåˆ¶åŒ–</strong>ï¼šå¯ä»¥æ ¹æ®é¡¹ç›®éœ€æ±‚å®šåˆ¶å®‰å…¨ç­–ç•¥ï¼Œä»è®¤è¯æµç¨‹åˆ°æˆæƒè§„åˆ™å‡å¯è‡ªå®šä¹‰ã€‚</li>
<li><strong>ä¸ Spring ç”Ÿæ€ç³»ç»Ÿæ— ç¼é›†æˆ</strong>ï¼šä¸ Spring Bootã€Spring MVC ç­‰å…¶ä»– Spring æ¨¡å—ç»“åˆç´§å¯†ï¼Œç®€åŒ–äº†å®‰å…¨é…ç½®å’Œç®¡ç†ã€‚</li>
</ul>
<p><strong>5. æ”¯æŒå¤šç§å®‰å…¨åè®®</strong></p>
<ul>
<li><strong>OAuth2 ä¸ OpenID Connect</strong>ï¼šå†…ç½®å¯¹ OAuth2 å’Œ OpenID Connect çš„æ”¯æŒï¼Œä¾¿äºæ„å»ºåŸºäºç¬¬ä¸‰æ–¹èº«ä»½éªŒè¯çš„åº”ç”¨ç¨‹åºã€‚</li>
<li><strong>LDAP é›†æˆ</strong>ï¼šæ”¯æŒ LDAP ä½œä¸ºç”¨æˆ·ä¿¡æ¯å’Œæƒé™çš„å­˜å‚¨æ–¹æ¡ˆï¼Œæ–¹ä¾¿ä¸ä¼ä¸šçº§è®¤è¯ç³»ç»Ÿé›†æˆã€‚</li>
</ul>
<hr>
<h1 id="å¿«é€Ÿå…¥é—¨"><a href="#å¿«é€Ÿå…¥é—¨" class="headerlink" title="å¿«é€Ÿå…¥é—¨"></a>å¿«é€Ÿå…¥é—¨</h1><p>åœ¨åŸæœ‰SpringBooté¡¹ç›®ä¸­å¼•å…¥ä¾èµ–å³å¯</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>å†æ¬¡è®¿é—®æ—¶ï¼Œä¼šå‡ºç°ç™»å½•çª—å£</p>
<img src="https://cdn.jsdelivr.net/gh/KNeegcyao/picdemo/img/image-20250404132135066.png" alt="image-20250404132135066" style="zoom:50%;" />

<p>ç”¨æˆ·åä¸ºuserï¼Œç™»å½•å¯†ç ä¼šæ‰“å°åœ¨æ§åˆ¶å°</p>
<p><img src="https://cdn.jsdelivr.net/gh/KNeegcyao/picdemo/img/image-20250404132159600.png" alt="image-20250404132159600"></p>
<p>ç™»å½•åå°±å¯ä»¥è®¿é—®åŸæ¥æ¥å£çš„æ•°æ®ã€‚</p>
<hr>
<h1 id="è®¤è¯"><a href="#è®¤è¯" class="headerlink" title="è®¤è¯"></a>è®¤è¯</h1><h2 id="ç™»å½•æ ¡éªŒæµç¨‹"><a href="#ç™»å½•æ ¡éªŒæµç¨‹" class="headerlink" title="ç™»å½•æ ¡éªŒæµç¨‹"></a><strong>ç™»å½•æ ¡éªŒæµç¨‹</strong></h2><p><img src="https://cdn.jsdelivr.net/gh/KNeegcyao/picdemo/img/image-20250404134627378.png" alt="image-20250404134627378"></p>
<h2 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h2><p>Spring Security ä¸»è¦é€šè¿‡ <strong>ä¸€ç³»åˆ—çš„è¿‡æ»¤å™¨ï¼ˆFilterï¼‰</strong> è¿›è¡Œè¯·æ±‚çš„æ‹¦æˆªã€è®¤è¯å’Œæˆæƒã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/KNeegcyao/picdemo/img/e820f60802784bd09fe7780d999a68e3.png" alt="ã€Spring Securityç³»åˆ—ã€‘Spring Security è¿‡æ»¤å™¨è¯¦è§£ä¸åŸºäºJDBCçš„è®¤è¯å®ç°_springsecurityè¿‡æ»¤å™¨é“¾ ..."></p>
<p>å¸¸è§çš„è¿‡æ»¤å™¨åŒ…æ‹¬ï¼š</p>
<table>
<thead>
<tr>
<th>è¿‡æ»¤å™¨åç§°</th>
<th align="center">ä½œç”¨</th>
</tr>
</thead>
<tbody><tr>
<td><code>SecurityContextPersistenceFilter</code></td>
<td align="center">è¯»å–ã€å­˜å‚¨ <code>SecurityContext</code> è®¤è¯ä¿¡æ¯</td>
</tr>
<tr>
<td><code>UsernamePasswordAuthenticationFilter</code></td>
<td align="center">å¤„ç†è¡¨å•ç™»å½•è¯·æ±‚ï¼ˆç”¨æˆ·åå¯†ç è®¤è¯ï¼‰</td>
</tr>
<tr>
<td><code>BasicAuthenticationFilter</code></td>
<td align="center">å¤„ç† Basic è®¤è¯</td>
</tr>
<tr>
<td><code>BearerTokenAuthenticationFilter</code></td>
<td align="center">è§£æ JWT Token è®¤è¯</td>
</tr>
<tr>
<td><code>ExceptionTranslationFilter</code></td>
<td align="center">å¤„ç†è®¤è¯æˆ–æˆæƒå¤±è´¥çš„å¼‚å¸¸</td>
</tr>
<tr>
<td><code>FilterSecurityInterceptor</code></td>
<td align="center">è¿›è¡Œæˆæƒï¼ˆæƒé™åˆ¤æ–­ï¼‰</td>
</tr>
</tbody></table>
<p>âš  è¿‡æ»¤å™¨é“¾çš„æ‰§è¡Œé¡ºåºå†³å®šäº† Spring Security å¤„ç†è¯·æ±‚çš„æ–¹å¼ã€‚</p>
<h2 id="è®¤è¯æµç¨‹"><a href="#è®¤è¯æµç¨‹" class="headerlink" title="è®¤è¯æµç¨‹"></a>è®¤è¯æµç¨‹</h2><p><img src="https://cdn.jsdelivr.net/gh/KNeegcyao/picdemo/img/image-20250405125501291.png" alt="image-20250405125501291"></p>
<table>
<thead>
<tr>
<th>åç§°</th>
<th>ç±»å‹</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody><tr>
<td><strong>UsernamePasswordAuthenticationFilter</strong></td>
<td>è¿‡æ»¤å™¨</td>
<td>æ‹¦æˆªç™»å½•è¯·æ±‚ï¼ˆé€šå¸¸æ˜¯ <code>/login</code>ï¼‰ï¼Œä» HTTP è¯·æ±‚ä¸­æå–ç”¨æˆ·åå’Œå¯†ç ï¼Œå°è£…æˆä¸€ä¸ªå¾…è®¤è¯çš„ <code>Authentication</code> å¯¹è±¡ï¼Œå¹¶è§¦å‘åç»­è®¤è¯æµç¨‹ã€‚</td>
</tr>
<tr>
<td><strong>ProviderManager</strong></td>
<td>è®¤è¯ç®¡ç†å™¨</td>
<td>å®ç°äº† <code>AuthenticationManager</code>ï¼Œå†…éƒ¨ç»´æŠ¤ä¸€ç»„ <code>AuthenticationProvider</code>ï¼Œè´Ÿè´£å°†è®¤è¯è¯·æ±‚å§”æ´¾ç»™èƒ½å¤„ç†è¯¥ç±»å‹ä»¤ç‰Œçš„ Providerã€‚</td>
</tr>
<tr>
<td><strong>DaoAuthenticationProvider</strong></td>
<td>è®¤è¯æä¾›è€…</td>
<td>å®ç°äº† <code>AuthenticationProvider</code>ï¼Œè°ƒç”¨ <code>UserDetailsService</code> åŠ è½½ç”¨æˆ·ã€æ ¡éªŒå¯†ç ï¼Œå¹¶åœ¨è®¤è¯æˆåŠŸåæ„é€ åŒ…å«ç”¨æˆ·æƒé™çš„ <code>Authentication</code>ã€‚</td>
</tr>
<tr>
<td><strong>InMemoryUserDetailsManager</strong></td>
<td>ç”¨æˆ·æœåŠ¡</td>
<td>å®ç°äº† <code>UserDetailsService</code>ï¼Œè´Ÿè´£æ ¹æ®ç”¨æˆ·åä»å†…å­˜ï¼ˆæˆ–æ•°æ®åº“ï¼‰ä¸­æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼Œå¹¶è¿”å›ä¸€ä¸ªåŒ…å«ç”¨æˆ·åã€å¯†ç ã€æƒé™ç­‰çš„ <code>UserDetails</code></td>
</tr>
</tbody></table>
<h3 id="æ—¶åºæ­¥éª¤è¯¦è§£"><a href="#æ—¶åºæ­¥éª¤è¯¦è§£" class="headerlink" title="æ—¶åºæ­¥éª¤è¯¦è§£"></a><strong>æ—¶åºæ­¥éª¤è¯¦è§£</strong></h3><ol>
<li><p><strong>æäº¤ç”¨æˆ·åå’Œå¯†ç </strong></p>
<ul>
<li><strong>Client â†’ UsernamePasswordAuthenticationFilter</strong><br>ç”¨æˆ·åœ¨ç™»å½•é¡µé¢è¾“å…¥ç”¨æˆ·å&#x2F;å¯†ç ï¼Œæµè§ˆå™¨å‘èµ· POST <code>/login</code> è¯·æ±‚ï¼Œ<code>UsernamePasswordAuthenticationFilter</code> æ‹¦æˆªè¯¥è¯·æ±‚ã€‚</li>
</ul>
</li>
<li><p><strong>å°è£… Authentication å¯¹è±¡</strong></p>
<ul>
<li><strong>UsernamePasswordAuthenticationFilter</strong><ul>
<li>ä»è¯·æ±‚ä¸­è§£æå‡ºç”¨æˆ·åå’Œå¯†ç </li>
<li>å°è£…æˆä¸€ä¸ª <code>UsernamePasswordAuthenticationToken</code>ï¼ˆæ­¤æ—¶ <code>isAuthenticated()==false</code>ï¼Œä¸”å†…éƒ¨åªæœ‰ç”¨æˆ·åå’Œå¯†ç ï¼Œæ²¡æœ‰æƒé™ä¿¡æ¯ï¼‰</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>è°ƒç”¨è®¤è¯ç®¡ç†å™¨</strong></p>
<ul>
<li><strong>UsernamePasswordAuthenticationFilter â†’ ProviderManager.authenticate(â€¦)</strong><br>å°†ä¸Šä¸€æ­¥çš„ <code>UsernamePasswordAuthenticationToken</code> ä¼ ç»™ <code>ProviderManager</code>ï¼ˆå³ <code>AuthenticationManager</code>ï¼‰è¿›è¡Œè®¤è¯ã€‚</li>
</ul>
</li>
<li><p><strong>å§”æ´¾ç»™ DaoAuthenticationProvider</strong></p>
<ul>
<li><strong>ProviderManager â†’ DaoAuthenticationProvider.authenticate(â€¦)</strong><br><code>ProviderManager</code> éå†å…¶æŒæœ‰çš„æ‰€æœ‰ <code>AuthenticationProvider</code>ï¼Œæ‰¾åˆ°æ”¯æŒ <code>UsernamePasswordAuthenticationToken</code> çš„ <code>DaoAuthenticationProvider</code>ï¼Œå¹¶è°ƒç”¨å®ƒçš„ <code>authenticate()</code> æ–¹æ³•ã€‚</li>
</ul>
</li>
<li><p><strong>åŠ è½½ç”¨æˆ·ä¿¡æ¯</strong></p>
<ul>
<li><p><strong>DaoAuthenticationProvider â†’ InMemoryUserDetailsManager.loadUserByUsername(username)</strong><br><code>DaoAuthenticationProvider</code> è°ƒç”¨ <code>UserDetailsService.loadUserByUsername</code>ï¼ŒæŸ¥è¯¢å¯¹åº”çš„ç”¨æˆ·è®°å½•åŠå…¶æƒé™ä¿¡æ¯ã€‚</p>
<ul>
<li>InMemoryUserDetailsManagerï¼ˆæˆ–å…¶ä»–å®ç°ï¼‰ä»å†…å­˜&#x2F;æ•°æ®åº“ä¸­æŸ¥åˆ°ç”¨æˆ·å®ä½“å’Œè¯¥ç”¨æˆ·çš„è§’è‰²&#x2F;æƒé™</li>
<li>å°†æŸ¥è¯¢åˆ°çš„ä¿¡æ¯å°è£…åˆ°ä¸€ä¸ª <code>UserDetails</code>ï¼ˆæ­¤å¤„æ˜¯ <code>LoginUser</code> æˆ– Spring æä¾›çš„ <code>User</code>ï¼‰å¯¹è±¡ä¸­è¿”å›</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>è¿”å› UserDetails å¯¹è±¡</strong></p>
<ul>
<li><strong>InMemoryUserDetailsManager â†’ DaoAuthenticationProvider</strong><br>è¿”å›åŒ…å«ç”¨æˆ·åã€åŠ å¯†å¯†ç ã€æƒé™åˆ—è¡¨ç­‰çš„ <code>UserDetails</code>ã€‚</li>
</ul>
</li>
<li><p><strong>å¯†ç æ ¡éªŒ</strong></p>
<ul>
<li><strong>DaoAuthenticationProvider</strong><ul>
<li>ä½¿ç”¨æ³¨å…¥çš„ <code>PasswordEncoder</code>ï¼ˆå¦‚ <code>BCryptPasswordEncoder</code>ï¼‰å°†ç”¨æˆ·æäº¤çš„å¯†ç åŠ å¯†åï¼Œä¸ <code>UserDetails.getPassword()</code>ï¼ˆæ•°æ®åº“ä¸­å·²åŠ å¯†çš„å¯†ç ï¼‰è¿›è¡Œæ¯”å¯¹ã€‚</li>
<li>å¦‚æœä¸åŒ¹é…ï¼Œåˆ™æŠ›å‡º <code>BadCredentialsException</code>ï¼Œè®¤è¯å¤±è´¥ã€‚</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>æ„é€ å·²è®¤è¯çš„ Authentication</strong></p>
<ul>
<li><strong>DaoAuthenticationProvider</strong><ul>
<li>å¦‚æœå¯†ç æ ¡éªŒé€šè¿‡ï¼Œå°±åŸºäºåŸæ¥çš„ <code>UsernamePasswordAuthenticationToken</code>ï¼Œå°†å…¶ <code>principal</code>ï¼ˆ<code>UserDetails</code>ï¼‰å’Œ <code>authorities</code>ï¼ˆæƒé™åˆ—è¡¨ï¼‰å¡«å……è¿›å»ï¼Œå¹¶å°† <code>authenticated</code> æ ‡å¿—è®¾ä¸º <code>true</code>ï¼Œå½¢æˆä¸€ä¸ªå®Œæ•´çš„å·²è®¤è¯ä»¤ç‰Œã€‚</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>è¿”å›å·²è®¤è¯çš„ Authentication</strong></p>
<ul>
<li><strong>DaoAuthenticationProvider â†’ ProviderManager â†’ UsernamePasswordAuthenticationFilter</strong><br>æœ€ç»ˆå°†è¿™ä¸ªå·²è®¤è¯çš„ <code>Authentication</code> å¯¹è±¡ä¸€è·¯è¿”å›ç»™æœ€åˆçš„è¿‡æ»¤å™¨ã€‚</li>
</ul>
</li>
<li><p><strong>ä¿å­˜åˆ° SecurityContextHolder</strong></p>
<ul>
<li><strong>UsernamePasswordAuthenticationFilter</strong><ul>
<li>è°ƒç”¨ <code>SecurityContextHolder.getContext().setAuthentication(authentication)</code>ï¼Œå°†è®¤è¯ç»“æœå­˜å…¥å½“å‰çº¿ç¨‹çš„å®‰å…¨ä¸Šä¸‹æ–‡ä¸­ï¼Œåç»­åŒä¸€è¯·æ±‚çš„å…¶ä»–è¿‡æ»¤å™¨æˆ–ä¸šåŠ¡ä»£ç éƒ½èƒ½é€šè¿‡ <code>SecurityContextHolder</code> è·å–åˆ°å½“å‰ç”¨æˆ·ä¿¡æ¯ã€‚</li>
<li>éšåé€šå¸¸ä¼šè·³è½¬åˆ°ç™»å½•æˆåŠŸé¡µé¢æˆ–è¿”å› JWT Tokenï¼ˆå‰åç«¯åˆ†ç¦»æ—¶ï¼‰</li>
</ul>
</li>
</ul>
</li>
</ol>
<h3 id="å½¢è±¡è§£é‡Š"><a href="#å½¢è±¡è§£é‡Š" class="headerlink" title="å½¢è±¡è§£é‡Š"></a>å½¢è±¡è§£é‡Š</h3><p>æƒ³è±¡ä½ è¦è¿›å…¥ä¸€å®¶é«˜çº§ä¿±ä¹éƒ¨ï¼Œæ•´ä¸ª Spring Security è®¤è¯æµç¨‹å°±åƒä½ ä»é—¨å¤–èµ°åˆ°ä¿±ä¹éƒ¨å¤§å ‚ï¼Œå†åˆ°æœ€ç»ˆæ‹¿åˆ° VIP é€šè¡Œè¯çš„è¿‡ç¨‹ï¼š</p>
<hr>
<ol>
<li>èµ°åˆ°é—¨å£â€”â€”<strong>UsernamePasswordAuthenticationFilterï¼ˆé—¨å«ï¼‰</strong></li>
</ol>
<p>ä½ æ¥åˆ°ä¿±ä¹éƒ¨é—¨å£ï¼Œé—¨å«ï¼ˆè¿‡æ»¤å™¨ï¼‰ä¼šå…ˆé—®ï¼šâ€œè¯·å‡ºç¤ºä½ çš„é‚€è¯·å‡½ï¼ˆç”¨æˆ·å&#x2F;å¯†ç ï¼‰ã€‚â€</p>
<ul>
<li>å¦‚æœä½ è¿é‚€è¯·å‡½éƒ½æ²¡å¸¦ï¼Œä»–ä¼šæ‹¦ä¸‹ä½ ï¼Œç›´æ¥è¯´â€œè¯·å…ˆç™»å½•â€ã€‚</li>
<li>å¦‚æœä½ é€’ä¸Šäº†é‚€è¯·å‡½ï¼Œä»–å°±æŠŠå®ƒäº¤ç»™ä¿å®‰é˜Ÿé•¿å»è¿›ä¸€æ­¥æ ¸å®ã€‚</li>
</ul>
<hr>
<ol start="2">
<li>æ‰¾ä¿å®‰é˜Ÿé•¿â€”â€”<strong>ProviderManagerï¼ˆä¿å®‰é˜Ÿé•¿ï¼‰</strong></li>
</ol>
<p>é—¨å«æŠŠé‚€è¯·å‡½äº¤ç»™ä¿å®‰é˜Ÿé•¿ï¼Œé˜Ÿé•¿è¯´ï¼šâ€œå¥½ï¼Œæˆ‘è¿™é‡Œæœ‰å¥½å‡ ä½ä¸“é—¨è´Ÿè´£ä¸åŒç±»å‹é‚€è¯·å‡½çš„ä¿å®‰ï¼ˆAuthenticationProviderï¼‰ï¼Œæˆ‘æ¥å†³å®šæŠŠä½ äº¤ç»™è°æ£€æŸ¥ã€‚â€</p>
<ul>
<li>é˜Ÿé•¿çœ‹äº†ä¸‹è¿™æ˜¯å¸¸è§„çš„â€œç”¨æˆ·å+å¯†ç â€é‚€è¯·å‡½ï¼Œå°±äº¤ç»™è´Ÿè´£è¿™ç±»çš„ä¿å®‰ï¼ˆ<code>DaoAuthenticationProvider</code>ï¼‰ã€‚</li>
</ul>
<hr>
<ol start="3">
<li>éªŒè¯èº«ä»½â€”â€”<strong>DaoAuthenticationProviderï¼ˆä¸“èŒæ ¸æŸ¥ä¿å®‰ï¼‰</strong></li>
</ol>
<p>è¿™ä½ä¿å®‰ä¼šå¸¦ä½ å»åå°æ¡£æ¡ˆå®¤ï¼ˆè°ƒç”¨ <code>UserDetailsService</code>ï¼‰æ‰¾ä½ çš„â€œä¼šå‘˜æ¡£æ¡ˆâ€ï¼š</p>
<ol>
<li>å»æ¡£æ¡ˆå®¤æŸ¥è¯¢ï¼šè¿™å°±åƒä»–æ‰“å¼€äº†ä¼šå‘˜æ•°æ®åº“ï¼Œæ‰¾åˆ°äº†ä½ çš„æ¡£æ¡ˆï¼ˆ<code>UserDetails</code>ï¼‰ã€‚</li>
<li>æ ¸å¯¹ç­¾åï¼šä¿å®‰æ‹¿ç€ä½ æ‰‹ä¸Šçš„ç­¾åï¼ˆå¯†ç ï¼‰ï¼Œç”¨ä»–ä»¬çš„å¯†é’¥ï¼ˆ<code>PasswordEncoder</code>ï¼‰è¿›è¡Œæ¯”å¯¹ã€‚</li>
</ol>
<ul>
<li><strong>æ¯”å¯¹ä¸ç¬¦</strong>ï¼šä¿å®‰ä¼šç«‹åˆ»è¯´â€œè¿™ç­¾åä¸å¯¹ï¼Œä½ ä¸æ˜¯ä¼šå‘˜â€ï¼Œè®¤è¯å¤±è´¥ã€‚</li>
<li><strong>æ¯”å¯¹é€šè¿‡</strong>ï¼šä¿å®‰ç»™ä½ ç›–ç« ï¼Œç»™ä½ çš„é‚€è¯·å‡½åŠ ä¸Šâ€œå·²è®¤è¯â€æ ‡è®°ï¼Œå‘Šè¯‰é˜Ÿé•¿â€œä»–æ˜¯çœŸä¼šå‘˜â€ã€‚</li>
</ul>
<hr>
<ol start="4">
<li>ç›–ä¸Šâ€œå·²è®¤è¯â€å°ç« â€”â€”<strong>è¿”å› Authentication</strong></li>
</ol>
<p>ä¿å®‰æŠŠâ€œå·²ç›–ç« çš„é‚€è¯·å‡½â€ï¼ˆå·²è®¤è¯çš„ <code>Authentication</code> å¯¹è±¡ï¼Œé‡Œé¢å†™ç€ä½ çš„ä¼šå‘˜ç­‰çº§ã€ç‰¹æƒåˆ—è¡¨ï¼‰äº¤è¿˜ç»™ä¿å®‰é˜Ÿé•¿ï¼Œé˜Ÿé•¿å†è½¬äº¤ç»™é—¨å«ã€‚</p>
<hr>
<ol start="5">
<li>ç™»è®°é€šè¡Œè¯â€”â€”<strong>SecurityContextHolderï¼ˆç­¾åˆ°ç°¿ï¼‰</strong></li>
</ol>
<p>é—¨å«æŠŠä½ çš„â€œå·²è®¤è¯é‚€è¯·å‡½â€æ”¾è¿›ç­¾åˆ°ç°¿ï¼ˆ<code>SecurityContext</code>ï¼‰ï¼Œè¿™æ ·æ•´ä¸ªä¿±ä¹éƒ¨å…¶ä»–åŒºåŸŸçš„å·¥ä½œäººå‘˜ï¼ˆåç»­çš„è¿‡æ»¤å™¨æˆ–ä¸šåŠ¡é€»è¾‘ï¼‰éƒ½èƒ½æŸ¥åˆ°ä½ çš„èº«ä»½å’Œæƒé™ã€‚</p>
<hr>
<ol start="6">
<li>å‘æ”¾ VIP é€šè¡Œè¯â€”â€”<strong>ç”Ÿæˆ JWT &amp; ç¼“å­˜</strong></li>
</ol>
<p>åŒæ—¶ï¼Œä¿±ä¹éƒ¨åå°ç»™ä½ åˆ¶ä½œäº†ä¸€å¼ å¸¦æœ‰ä½ èº«ä»½ä¿¡æ¯å’Œåˆ°æœŸæ—¶é—´çš„ VIP é€šè¡Œè¯ï¼ˆJWTï¼‰ï¼Œå¹¶åœ¨é—¨å«åŠå…¬å®¤ï¼ˆRedisï¼‰å­˜äº†ä¸€ä»½ä½ çš„æ¡£æ¡ˆå‰¯æœ¬ï¼š</p>
<ul>
<li><strong>JWT</strong>ï¼šå°±åƒä¸€å¼ åŠ å¯†çš„ç”µå­é€šè¡Œè¯ï¼Œä½ ç¦»å¼€åè¿˜å¯ä»¥å‡­å®ƒå†æ¬¡è¿›å…¥ã€‚</li>
<li><strong>Redis ç¼“å­˜</strong>ï¼šå°±åƒé—¨å«åŠå…¬å®¤é‡Œå­˜äº†ä¸€ä»½ä½ çš„ä¼šå‘˜èµ„æ–™å¤å°ä»¶ï¼ŒåŠ å¿«ä¸‹æ¬¡éªŒè¯é€Ÿåº¦ã€‚</li>
</ul>
<hr>
<ol start="7">
<li>ä½ æ‹¿ç€é€šè¡Œè¯å…¥å†…</li>
</ol>
<p>æ‹¿åˆ°é€šè¡Œè¯åï¼Œä½ å°±å¯ä»¥è‡ªç”±è¿›å‡ºä¿±ä¹éƒ¨çš„å„ä¸ªå—ä¿æŠ¤åŒºåŸŸï¼ˆå—ä¿æŠ¤çš„ APIï¼‰ã€‚æ¯æ¬¡è¿›é—¨ï¼Œé—¨å«åªè¦æ‰«æä½ çš„é€šè¡Œè¯ï¼ˆè§£æ JWTï¼‰ï¼Œç¡®è®¤ç­¾åæ²¡é—®é¢˜ï¼Œå†ä»åŠå…¬å®¤ï¼ˆRedisï¼‰å¿«é€Ÿå–å‡ºä½ çš„ä¼šå‘˜æ¡£æ¡ˆï¼Œå°±çŸ¥é“ä½ æœ‰å“ªå‡ ç§ç‰¹æƒã€‚</p>
<hr>
<ol start="8">
<li>æ³¨é”€ç¦»åœºâ€”â€”<strong>logoutï¼ˆé”€æ¯ç¼“å­˜ï¼‰</strong></li>
</ol>
<p>å½“ä½ è¦ç¦»å¼€æ—¶ï¼Œé—¨å«æŠŠä½ åœ¨åŠå…¬å®¤çš„ä¼šå‘˜æ¡£æ¡ˆå¤å°ä»¶ï¼ˆRedis ç¼“å­˜ï¼‰é”€æ¯ã€‚è¿™æ ·å³ä½¿æœ‰äººæ¡åˆ°ä½ çš„æ—§é€šè¡Œè¯ï¼Œé—¨å«æ‰«æåä¹ŸæŸ¥ä¸åˆ°ä½ çš„æ¡£æ¡ˆï¼Œå°±ä¼šè¢«æ‹’ç»å…¥å†…ã€‚</p>
<h2 id="å…·ä½“å®ç°"><a href="#å…·ä½“å®ç°" class="headerlink" title="å…·ä½“å®ç°"></a>å…·ä½“å®ç°</h2><p><strong>æµç¨‹</strong>ï¼šå‰ç«¯â†’å°è£…ä»¤ç‰Œâ†’<code>AuthenticationManager</code>â†’<code>UserDetailsService</code>+<code>PasswordEncoder</code>â†’è®¤è¯é€šè¿‡â†’ç”Ÿæˆ JWTâ†’Redis ç¼“å­˜â†’è¿”å› Token</p>
<p>åˆ›å»ºä¸€ä¸ªç±»å®ç°UserDetailsServiceæ¥å£,è‡ªå®šä¹‰åŠ è½½é€»è¾‘</p>
<ul>
<li>é»˜è®¤æƒ…å†µä¸‹ï¼ŒSpring Security å¹¶ä¸çŸ¥é“ä½ çš„ç”¨æˆ·æ•°æ®å­˜åœ¨å“ªé‡Œï¼Œä¹Ÿä¸çŸ¥é“ä½ ç”¨çš„æ˜¯å“ªå¼ è¡¨ã€å“ªç§ ORMã€‚</li>
<li>é€šè¿‡è‡ªå·±å®ç° <code>loadUserByUsername</code>ï¼Œä½ å¯ä»¥ï¼š<ul>
<li>ä»æ•°æ®åº“ï¼ˆMyBatisã€JPAã€JDBCï¼‰ã€ç¼“å­˜ï¼ˆRedisï¼‰ã€å¤–éƒ¨ç³»ç»Ÿï¼ˆLDAPã€å¾®æœåŠ¡ï¼‰ä¸­æŸ¥è¯¢ç”¨æˆ·ï¼›</li>
<li>æŸ¥è¯¢ç”¨æˆ·çš„è§’è‰²å’Œæƒé™ï¼ŒæŠŠå®ƒä»¬å°è£…åˆ°è¿”å›çš„ <code>UserDetails</code>ï¼ˆè¿™é‡Œæ˜¯ <code>LoginUser</code>ï¼‰é‡Œï¼›</li>
<li>å¯¹ä¸å­˜åœ¨çš„ç”¨æˆ·æŠ›å‡ºå¼‚å¸¸ï¼Œè®© Spring Security çŸ¥é“è¯¥å¦‚ä½•åé¦ˆâ€œç”¨æˆ·åä¸å­˜åœ¨â€æˆ–â€œå¯†ç é”™è¯¯â€çš„ä¿¡æ¯ã€‚</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserDetailsServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">UserDetailsService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> UserDetails <span class="title function_">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException &#123;</span><br><span class="line">        <span class="comment">//æ ¹æ®ç”¨æˆ·åæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line">        LambdaQueryWrapper&lt;User&gt; wrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">        wrapper.eq(User::getUserName,username);</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userMapper.selectOne(wrapper);</span><br><span class="line">        <span class="comment">//å¦‚æœæŸ¥è¯¢ä¸åˆ°æ•°æ®å°±é€šè¿‡æŠ›å‡ºå¼‚å¸¸æ¥ç»™å‡ºæç¤º</span></span><br><span class="line">        <span class="keyword">if</span>(Objects.isNull(user))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//TODO æ ¹æ®ç”¨æˆ·æŸ¥è¯¢æƒé™ä¿¡æ¯ æ·»åŠ åˆ°LoginUserä¸­</span></span><br><span class="line">  </span><br><span class="line">        <span class="comment">//å°è£…æˆUserDetailså¯¹è±¡è¿”å› </span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LoginUser</span>(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å› ä¸ºUserDetailsServiceæ–¹æ³•çš„è¿”å›å€¼æ˜¯UserDetailsç±»å‹ï¼Œæ‰€ä»¥éœ€è¦å®šä¹‰ä¸€ä¸ªç±»ï¼Œå®ç°è¯¥æ¥å£ï¼ŒæŠŠç”¨æˆ·ä¿¡æ¯å°è£…åœ¨å…¶ä¸­ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginUser</span> <span class="keyword">implements</span> <span class="title class_">UserDetails</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> User user;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Collection&lt;? <span class="keyword">extends</span> <span class="title class_">GrantedAuthority</span>&gt; getAuthorities() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPassword</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> user.getPassword();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUsername</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> user.getUserName();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isAccountNonExpired</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isAccountNonLocked</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isCredentialsNonExpired</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isEnabled</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="å¯†ç åŠ å¯†å­˜å‚¨"><a href="#å¯†ç åŠ å¯†å­˜å‚¨" class="headerlink" title="å¯†ç åŠ å¯†å­˜å‚¨"></a>å¯†ç åŠ å¯†å­˜å‚¨</h3><p>æˆ‘ä»¬ä¸€èˆ¬ä½¿ç”¨SpringSecurityä¸ºæˆ‘ä»¬æä¾›çš„BCryptPasswordEncoderã€‚</p>
<p>æˆ‘ä»¬åªéœ€è¦ä½¿ç”¨æŠŠBCryptPasswordEncoderå¯¹è±¡æ³¨å…¥Springå®¹å™¨ä¸­ï¼ŒSpringSecurityå°±ä¼šä½¿ç”¨è¯¥PasswordEncoderæ¥è¿›è¡Œå¯†ç æ ¡éªŒã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªSpringSecurityçš„é…ç½®ç±»</p>
<p>1.<strong>åŸºäº <code>WebSecurityConfigurerAdapter</code>ï¼ˆ5.6 åŠæ›´æ—©ç‰ˆæœ¬ï¼‰</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> PasswordEncoder <span class="title function_">passwordEncoder</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    JwtAuthenticationTokenFilter jwtAuthenticationTokenFilter;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http</span><br><span class="line">                <span class="comment">//å…³é—­csrf</span></span><br><span class="line">                .csrf().disable()</span><br><span class="line">                <span class="comment">//ä¸é€šè¿‡sessionè·å–SecurityContext</span></span><br><span class="line">                .sessionManagement().disable()</span><br><span class="line">                .authorizeRequests()</span><br><span class="line">                <span class="comment">// å¯¹äºç™»å½•æ¥å£ å…è®¸åŒ¿åè®¿é—®</span></span><br><span class="line">                .antMatchers(<span class="string">&quot;/user/login&quot;</span>).anonymous()</span><br><span class="line">                <span class="comment">// é™¤ä¸Šé¢å¤–çš„æ‰€æœ‰è¯·æ±‚å…¨éƒ¨éœ€è¦é‰´æƒè®¤è¯</span></span><br><span class="line">                .anyRequest().authenticated();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//æŠŠtokenæ ¡éªŒè¿‡æ»¤å™¨æ·»åŠ åˆ°è¿‡æ»¤å™¨é“¾ä¸­</span></span><br><span class="line">        <span class="comment">//addFilterBeforeè¡¨ç¤ºåœ¨æŸæŸä¹‹å‰æ·»åŠ </span></span><br><span class="line">        <span class="comment">//è¿™é‡Œè¡¨ç¤ºæˆ‘ä»¬çš„jwtAuthenticationTokenFilterè¿‡æ»¤å™¨åœ¨UsernamePasswordAuthenticationFilterä¹‹å‰æ‰§è¡Œ</span></span><br><span class="line">        http.addFilterBefore(jwtAuthenticationTokenFilter, UsernamePasswordAuthenticationFilter.class);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//åœ¨æ¥å£ä¸­æˆ‘ä»¬é€šè¿‡AuthenticationManagerçš„authenticateæ–¹æ³•æ¥è¿›è¡Œç”¨æˆ·è®¤è¯,</span></span><br><span class="line">    <span class="comment">//æ‰€ä»¥éœ€è¦åœ¨SecurityConfigä¸­é…ç½®æŠŠAuthenticationManageræ³¨å…¥å®¹å™¨ã€‚</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> AuthenticationManager <span class="title function_">authenticationManagerBean</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.authenticationManagerBean();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2.<strong>Spring Security 5.7+</strong> æ¨èçš„ <strong>æ— ä¾µå…¥å¼ Bean é…ç½®</strong>ï¼ˆä¸å†ç»§æ‰¿ <code>WebSecurityConfigurerAdapter</code>ï¼‰</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. å¯†ç åŠ å¯†å™¨</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> PasswordEncoder <span class="title function_">passwordEncoder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. æ ¸å¿ƒå®‰å…¨è¿‡æ»¤é“¾</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SecurityFilterChain <span class="title function_">securityFilterChain</span><span class="params">(HttpSecurity http,</span></span><br><span class="line"><span class="params">                                                   JwtAuthenticationFilter jwtFilter)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http</span><br><span class="line">            .csrf().disable()                                <span class="comment">// å…³é—­ CSRF</span></span><br><span class="line">            .sessionManagement().sessionCreationPolicy(</span><br><span class="line">                SessionCreationPolicy.STATELESS)             <span class="comment">// æ— çŠ¶æ€ä¼šè¯</span></span><br><span class="line">            .and()</span><br><span class="line">            .authorizeHttpRequests(authz -&gt; authz</span><br><span class="line">                .antMatchers(<span class="string">&quot;/user/login&quot;</span>).anonymous()     <span class="comment">// ç™»å½•æ¥å£å…è®¸åŒ¿å</span></span><br><span class="line">                .anyRequest().authenticated()               <span class="comment">// å…¶ä»–éƒ½è¦è®¤è¯</span></span><br><span class="line">            )</span><br><span class="line">            <span class="comment">// åœ¨ç”¨æˆ·å/å¯†ç è¿‡æ»¤å™¨ä¹‹å‰ï¼Œå…ˆèµ° JWT è®¤è¯</span></span><br><span class="line">            .addFilterBefore(jwtFilter, UsernamePasswordAuthenticationFilter.class);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> http.build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. å¦‚æœä½ æœ‰è‡ªå®šä¹‰çš„ UserDetailsServiceï¼Œä¹Ÿå¯ä»¥åœ¨è¿™é‡Œæ³¨å†Œ</span></span><br><span class="line">    <span class="comment">// @Bean</span></span><br><span class="line">    <span class="comment">// public UserDetailsService userDetailsService(...) &#123; ... &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. å¦‚æœä½ è¿˜éœ€è¦æš´éœ² AuthenticationManagerï¼ˆæ¯”å¦‚åœ¨ Controller é‡Œæ‰‹åŠ¨è°ƒç”¨ï¼‰</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> AuthenticationManager <span class="title function_">authenticationManager</span><span class="params">(AuthenticationConfiguration authConfig)</span> </span><br><span class="line">            <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> authConfig.getAuthenticationManager();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="å®šä¹‰ç™»å½•æ¥å£"><a href="#å®šä¹‰ç™»å½•æ¥å£" class="headerlink" title="å®šä¹‰ç™»å½•æ¥å£"></a>å®šä¹‰ç™»å½•æ¥å£</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> LoginServcie loginServcie;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/user/login&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseResult <span class="title function_">login</span><span class="params">(<span class="meta">@RequestBody</span> User user)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> loginServcie.login(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">LoginService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    AuthenticationManager authenticationManager;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RedisCache redisCache;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ResponseResult <span class="title function_">login</span><span class="params">(User user)</span>&#123;</span><br><span class="line">        <span class="type">UsernamePasswordAuthenticationToken</span> <span class="variable">authenticationToken</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(user.getUserName(), user.getPassword());</span><br><span class="line">        <span class="type">Authentication</span> <span class="variable">authenticate</span> <span class="operator">=</span> authenticationManager.authenticate(authenticationToken);</span><br><span class="line">        <span class="keyword">if</span>(Objects.isNull(authenticate))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//ä½¿ç”¨userid ç”Ÿæˆtoken</span></span><br><span class="line">        <span class="type">LoginUser</span> <span class="variable">loginUser</span> <span class="operator">=</span>(LoginUser)authenticate.getPrincipal();</span><br><span class="line">        <span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> loginUser.getUser().getId().toString();</span><br><span class="line">        <span class="type">String</span> <span class="variable">jwt</span> <span class="operator">=</span> JwtUtil.createJWT(userId);</span><br><span class="line">        <span class="comment">//authenticateå­˜å…¥redis</span></span><br><span class="line">        redisCache.setCacheObject(<span class="string">&quot;login+&quot;</span>+userId,loginUser);</span><br><span class="line">        <span class="comment">//æŠŠtokenå“åº”ç»™å‰ç«¯</span></span><br><span class="line">        HashMap&lt;String,String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;token&quot;</span>,jwt);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ResponseResult</span>(<span class="number">200</span>,<span class="string">&quot;ç™»å½•æˆåŠŸ&quot;</span>,map);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ResponseResult <span class="title function_">logout</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">Authentication</span> <span class="variable">authentication</span> <span class="operator">=</span> SecurityContextHolder.getContext().getAuthentication();</span><br><span class="line">        <span class="type">LoginUser</span> <span class="variable">loginUser</span> <span class="operator">=</span> (LoginUser)authentication.getPrincipal();</span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> loginUser.getUser().getId();</span><br><span class="line">        redisCache.deleteObject(<span class="string">&quot;login:&quot;</span>+userId);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ResponseResult</span>(<span class="number">200</span>,<span class="string">&quot;æ³¨é”€æˆåŠŸ&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è¿™æ®µä»£ç æ˜¯ Spring Security + JWT è¿›è¡Œ<strong>ç™»å½•è®¤è¯</strong>çš„ <code>LoginServiceImpl</code> å®ç°ã€‚å®ƒçš„ä¸»è¦ä½œç”¨æ˜¯ï¼š</p>
<ol>
<li><strong>éªŒè¯ç”¨æˆ·åå’Œå¯†ç </strong>ï¼Œé€šè¿‡ <code>AuthenticationManager</code> è¿›è¡Œè®¤è¯ã€‚</li>
<li><strong>ç”Ÿæˆ JWT Token</strong>ï¼Œç”¨äºåç»­è¯·æ±‚çš„èº«ä»½è®¤è¯ã€‚</li>
<li><strong>å°†ç”¨æˆ·ä¿¡æ¯å­˜å…¥ Redis</strong>ï¼Œæ–¹ä¾¿åç»­çš„ Token è§£æã€‚</li>
<li><strong>è¿”å› JWT Token ç»™å‰ç«¯</strong>ï¼Œå‰ç«¯åœ¨åç»­è¯·æ±‚æ—¶æºå¸¦ Token è¿›è¡Œèº«ä»½è®¤è¯ã€‚</li>
</ol>
<hr>
<p> <strong>ğŸ” è¯¦ç»†è§£æä»£ç </strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">LoginService</span> &#123;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œ <code>LoginServiceImpl</code> <strong>å®ç°</strong> äº† <code>LoginService</code> æ¥å£ï¼Œè¡¨ç¤ºå®ƒæ˜¯ä¸€ä¸ª<strong>ç”¨æˆ·ç™»å½•çš„ä¸šåŠ¡é€»è¾‘ç±»</strong>ã€‚</p>
<hr>
<p>  <strong>1ï¸âƒ£ æ³¨å…¥ä¾èµ–</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">AuthenticationManager authenticationManager;</span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">RedisCache redisCache;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>authenticationManager</code>ï¼šSpring Security æä¾›çš„è®¤è¯ç®¡ç†å™¨ï¼Œ<strong>ç”¨æ¥æ ¡éªŒç”¨æˆ·åå’Œå¯†ç æ˜¯å¦æ­£ç¡®</strong>ã€‚</li>
<li><code>redisCache</code>ï¼šç”¨äº<strong>å°†ç”¨æˆ·ä¿¡æ¯å­˜å…¥ Redis</strong>ï¼Œä»¥ä¾¿åç»­ä½¿ç”¨ã€‚</li>
</ul>
<hr>
<p> <strong>2ï¸âƒ£ å¤„ç†ç”¨æˆ·ç™»å½•</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ResponseResult <span class="title function_">login</span><span class="params">(User user)</span>&#123;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªæ–¹æ³•çš„ä½œç”¨æ˜¯ï¼š<br> <strong>ç”¨æˆ·ç™»å½• -&gt; éªŒè¯èº«ä»½ -&gt; ç”Ÿæˆ Token -&gt; å­˜å…¥ Redis -&gt; è¿”å› Token</strong></p>
<p> <strong>ğŸ“Œ 2.1 æ„é€  <code>AuthenticationToken</code> è¿›è¡Œè®¤è¯</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">UsernamePasswordAuthenticationToken</span> <span class="variable">authenticationToken</span> <span class="operator">=</span> </span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(user.getUserName(), user.getPassword());</span><br></pre></td></tr></table></figure>

<ul>
<li><code>UsernamePasswordAuthenticationToken</code> æ˜¯ Spring Security å†…ç½®çš„ <strong>ç”¨æˆ·å+å¯†ç è®¤è¯</strong> ä»¤ç‰Œã€‚</li>
<li>è¿™ä¸ªå¯¹è±¡<strong>å°è£…äº†ç”¨æˆ·æäº¤çš„ç”¨æˆ·åå’Œå¯†ç </strong>ï¼Œåç»­äº¤ç»™ <code>AuthenticationManager</code> è¿›è¡Œè®¤è¯ã€‚</li>
</ul>
<hr>
<p> <strong>ğŸ“Œ 2.2 è¿›è¡Œèº«ä»½è®¤è¯</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Authentication</span> <span class="variable">authenticate</span> <span class="operator">=</span> authenticationManager.authenticate(authenticationToken);</span><br></pre></td></tr></table></figure>

<ul>
<li><code>authenticationManager.authenticate(authenticationToken)</code> è´Ÿè´£è°ƒç”¨ <strong>Spring Security çš„è®¤è¯æµç¨‹</strong>ï¼š<ul>
<li>é€šè¿‡ <strong><code>UserDetailsService</code> æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯</strong>ï¼ˆé€šå¸¸æ˜¯æ•°æ®åº“æŸ¥è¯¢ï¼‰ã€‚</li>
<li>ä½¿ç”¨ <strong><code>PasswordEncoder</code> æ ¡éªŒå¯†ç æ˜¯å¦æ­£ç¡®</strong>ã€‚</li>
<li>å¦‚æœè®¤è¯æˆåŠŸï¼Œè¿”å›ä¸€ä¸ª <code>Authentication</code> å¯¹è±¡ï¼Œå…¶ä¸­åŒ…å«äº†ç”¨æˆ·çš„æƒé™ä¿¡æ¯ã€‚</li>
</ul>
</li>
<li>å¦‚æœ <code>authenticate == null</code>ï¼Œè¯´æ˜<strong>ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯</strong>ï¼ŒæŠ›å‡ºå¼‚å¸¸ï¼š</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(Objects.isNull(authenticate))&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p> <strong>ğŸ“Œ 2.3 ç”Ÿæˆ JWT Token</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">LoginUser</span> <span class="variable">loginUser</span> <span class="operator">=</span> (LoginUser) authenticate.getPrincipal();</span><br><span class="line"><span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> loginUser.getUser().getId().toString();</span><br><span class="line"><span class="type">String</span> <span class="variable">jwt</span> <span class="operator">=</span> JwtUtil.createJWT(userId);</span><br></pre></td></tr></table></figure>

<ul>
<li><code>authenticate.getPrincipal()</code> è¿”å›çš„æ˜¯ <code>UserDetails</code>ï¼ˆæˆ‘ä»¬è¿™é‡Œçš„ <code>LoginUser</code>ï¼‰ã€‚</li>
<li><code>userId</code> å–å‡ºç”¨æˆ· IDï¼ˆå› ä¸º JWT éœ€è¦ä¸€ä¸ªå”¯ä¸€æ ‡è¯†ï¼‰ã€‚</li>
<li><code>JwtUtil.createJWT(userId)</code> ç”Ÿæˆ JWT Tokenï¼Œåç»­è¯·æ±‚éƒ½ä¼šæºå¸¦è¿™ä¸ª Token è¿›è¡Œèº«ä»½è®¤è¯ã€‚</li>
</ul>
<hr>
<p> <strong>ğŸ“Œ 2.4 å­˜å…¥ Redis</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redisCache.setCacheObject(<span class="string">&quot;login+&quot;</span>+userId, loginUser);</span><br></pre></td></tr></table></figure>

<ul>
<li>æŠŠ <code>LoginUser</code>ï¼ˆåŒ…æ‹¬ç”¨æˆ·ä¿¡æ¯å’Œæƒé™ï¼‰å­˜å…¥ Redisï¼Œé”®åæ˜¯ <code>&quot;login+userId&quot;</code>ã€‚</li>
<li>åç»­ç”¨æˆ·è¯·æ±‚æ—¶ï¼Œç³»ç»Ÿä¼šç”¨ JWT ä¸­çš„ <code>userId</code> å» Redis æŸ¥æ‰¾ç”¨æˆ·ä¿¡æ¯ï¼Œ<strong>é¿å…æ¯æ¬¡éƒ½æŸ¥è¯¢æ•°æ®åº“</strong>ã€‚</li>
</ul>
<hr>
<p> <strong>ğŸ“Œ 2.5 è¿”å› Token</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HashMap&lt;String,String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">map.put(<span class="string">&quot;token&quot;</span>, jwt);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ResponseResult</span>(<span class="number">200</span>, <span class="string">&quot;ç™»å½•æˆåŠŸ&quot;</span>, map);</span><br></pre></td></tr></table></figure>

<ul>
<li>åˆ›å»º <code>HashMap&lt;String, String&gt;</code> å­˜æ”¾ <code>token</code>ï¼Œè¿”å›ç»™å‰ç«¯ã€‚</li>
<li>å‰ç«¯æ‹¿åˆ° Token åï¼Œ<strong>åç»­è¯·æ±‚ä¼šåœ¨ <code>Authorization</code> å¤´éƒ¨æºå¸¦è¿™ä¸ª Token è¿›è¡Œèº«ä»½è®¤è¯</strong>ã€‚</li>
</ul>
<hr>
<p> <strong>ğŸ” ä»£ç æ‰§è¡Œæµç¨‹</strong></p>
<ol>
<li><strong>å‰ç«¯</strong> å‘é€ <code>POST</code> è¯·æ±‚åˆ° <code>/user/login</code>ï¼Œæºå¸¦ç”¨æˆ·åå’Œå¯†ç ã€‚</li>
<li><strong>Spring Security è®¤è¯</strong><ul>
<li><code>authenticationManager.authenticate()</code> è°ƒç”¨ <code>UserDetailsService</code> æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ã€‚</li>
<li><code>PasswordEncoder</code> è¿›è¡Œå¯†ç æ ¡éªŒã€‚</li>
<li>è®¤è¯æˆåŠŸï¼Œè¿”å› <code>Authentication</code> å¯¹è±¡ã€‚</li>
</ul>
</li>
<li><strong>ç”Ÿæˆ JWT Token</strong>ï¼Œç”¨äºåç»­çš„è¯·æ±‚èº«ä»½è®¤è¯ã€‚</li>
<li><strong>ç”¨æˆ·ä¿¡æ¯å­˜å…¥ Redis</strong>ï¼Œé¿å…æ¯æ¬¡éƒ½æŸ¥è¯¢æ•°æ®åº“ã€‚</li>
<li><strong>è¿”å› Token ç»™å‰ç«¯</strong>ï¼Œå‰ç«¯åç»­è¯·æ±‚å¸¦ä¸Š Tokenã€‚</li>
</ol>
<hr>
<p> <strong>ğŸ“ æ€»ç»“</strong></p>
<table>
<thead>
<tr>
<th>æ­¥éª¤</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td><strong>1. è®¤è¯</strong></td>
<td><code>authenticationManager.authenticate(authenticationToken)</code> è¿›è¡Œç”¨æˆ·è®¤è¯</td>
</tr>
<tr>
<td><strong>2. ç”Ÿæˆ JWT</strong></td>
<td><code>JwtUtil.createJWT(userId)</code> ç”Ÿæˆ Token</td>
</tr>
<tr>
<td><strong>3. å­˜å…¥ Redis</strong></td>
<td><code>redisCache.setCacheObject(&quot;login+&quot;+userId, loginUser)</code> ç¼“å­˜ç”¨æˆ·ä¿¡æ¯</td>
</tr>
<tr>
<td><strong>4. è¿”å› Token</strong></td>
<td>è¿”å› JWT ç»™å‰ç«¯ï¼Œå‰ç«¯å­˜å‚¨å¹¶åœ¨è¯·æ±‚ä¸­æºå¸¦</td>
</tr>
</tbody></table>
<p>è¿™æ®µä»£ç çš„ç›®çš„æ˜¯ <strong>ç”¨ JWT æ›¿ä»£ Session è¿›è¡Œèº«ä»½è®¤è¯</strong>ï¼Œå¹¶ç»“åˆ <strong>Redis è¿›è¡Œç¼“å­˜</strong>ï¼Œæå‡ç³»ç»Ÿæ€§èƒ½ã€‚ğŸš€</p>
<h3 id="è®¤è¯è¿‡æ»¤å™¨"><a href="#è®¤è¯è¿‡æ»¤å™¨" class="headerlink" title="è®¤è¯è¿‡æ»¤å™¨"></a>è®¤è¯è¿‡æ»¤å™¨</h3><p>æˆ‘ä»¬éœ€è¦è‡ªå®šä¹‰ä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œè¿™ä¸ªè¿‡æ»¤å™¨ä¼šå»è·å–è¯·æ±‚å¤´ä¸­çš„tokenï¼Œå¯¹tokenè¿›è¡Œè§£æå–å‡ºå…¶ä¸­çš„useridã€‚</p>
<p>ä½¿ç”¨useridå»redisä¸­è·å–å¯¹åº”çš„LoginUserå¯¹è±¡ã€‚</p>
<p>ç„¶åå°è£…Authenticationå¯¹è±¡å­˜å…¥SecurityContextHolder</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtAuthenticationTokenFilter</span> <span class="keyword">extends</span> <span class="title class_">OncePerRequestFilter</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisCache redisCache;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doFilterInternal</span><span class="params">(HttpServletRequest request,</span></span><br><span class="line"><span class="params">                                    HttpServletResponse response,</span></span><br><span class="line"><span class="params">                                    FilterChain filterChain)</span></span><br><span class="line">                                    <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="comment">// 1. ä»è¯·æ±‚å¤´è·å– token</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;token&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.hasText(token)) &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœæ²¡æœ‰æºå¸¦ tokenï¼Œç›´æ¥æ”¾è¡Œï¼ˆè®©åç»­çš„è¿‡æ»¤å™¨æˆ–æ§åˆ¶å™¨å†³å®šæ˜¯å¦éœ€è¦ç™»å½•ï¼‰</span></span><br><span class="line">            filterChain.doFilter(request, response);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. è§£æ tokenï¼Œæå– userId</span></span><br><span class="line">        String userId;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> JwtUtil.parseJWT(token);</span><br><span class="line">            userId = claims.getSubject();      <span class="comment">// JWT çš„ subject å­—æ®µé‡Œå­˜æ”¾çš„æ˜¯ç”¨æˆ· ID</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// è§£æå¤±è´¥ï¼ˆè¿‡æœŸã€ç­¾åä¸åŒ¹é…ç­‰ï¼‰ï¼ŒæŠ›å‡ºå¼‚å¸¸æˆ–è¿”å› 401</span></span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;token éæ³•æˆ–å·²è¿‡æœŸ&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. ä» Redis ä¸­åŠ è½½ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">redisKey</span> <span class="operator">=</span> <span class="string">&quot;login:&quot;</span> + userId;</span><br><span class="line">        <span class="type">LoginUser</span> <span class="variable">loginUser</span> <span class="operator">=</span> redisCache.getCacheObject(redisKey);</span><br><span class="line">        <span class="keyword">if</span> (Objects.isNull(loginUser)) &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœç¼“å­˜ä¸­æ²¡æœ‰ç”¨æˆ·ä¿¡æ¯ï¼Œè¯´æ˜ç”¨æˆ·æœªç™»å½•æˆ–å·²æ³¨é”€</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;ç”¨æˆ·æœªç™»å½•&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. æ„é€  Authentication å¹¶å­˜å…¥ SecurityContext</span></span><br><span class="line">        <span class="comment">//    <span class="doctag">TODO:</span> å¯ä»¥ä» loginUser ä¸­è·å–æƒé™åˆ—è¡¨ï¼Œå¡«å……åˆ°ç¬¬ä¸‰ä¸ªå‚æ•° authorities</span></span><br><span class="line">        <span class="type">UsernamePasswordAuthenticationToken</span> <span class="variable">authenticationToken</span> <span class="operator">=</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(</span><br><span class="line">                loginUser,      <span class="comment">// principalï¼šå½“å‰ç™»å½•ç”¨æˆ·è¯¦æƒ…</span></span><br><span class="line">                <span class="literal">null</span>,           <span class="comment">// credentialsï¼šå› ä¸ºå·²é€šè¿‡ JWT è®¤è¯ï¼Œä¸éœ€è¦å¯†ç </span></span><br><span class="line">                <span class="literal">null</span>            <span class="comment">// authoritiesï¼šç”¨æˆ·æƒé™åˆ—è¡¨ï¼Œåç»­å¯è¡¥å……</span></span><br><span class="line">            );</span><br><span class="line">        SecurityContextHolder.getContext().setAuthentication(authenticationToken);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. ç»§ç»­æ‰§è¡Œåç»­è¿‡æ»¤å™¨é“¾</span></span><br><span class="line">        filterChain.doFilter(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="æ³¨é”€"><a href="#æ³¨é”€" class="headerlink" title="æ³¨é”€"></a>æ³¨é”€</h3><p>æˆ‘ä»¬åªéœ€è¦å®šä¹‰ä¸€ä¸ªæ³¨é”€æ¥å£ï¼Œç„¶åè·å–SecurityContextHolderä¸­çš„è®¤è¯ä¿¡æ¯ï¼Œåˆ é™¤redisä¸­å¯¹åº”çš„æ•°æ®å³å¯</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ResponseResult <span class="title function_">logout</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Authentication</span> <span class="variable">authentication</span> <span class="operator">=</span> SecurityContextHolder.getContext().getAuthentication();</span><br><span class="line">    <span class="type">LoginUser</span> <span class="variable">loginUser</span> <span class="operator">=</span> (LoginUser) authentication.getPrincipal();</span><br><span class="line">    <span class="type">Long</span> <span class="variable">userid</span> <span class="operator">=</span> loginUser.getUser().getId();</span><br><span class="line">    redisCache.deleteObject(<span class="string">&quot;login:&quot;</span>+userid);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ResponseResult</span>(<span class="number">200</span>,<span class="string">&quot;é€€å‡ºæˆåŠŸ&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="æˆæƒ"><a href="#æˆæƒ" class="headerlink" title="æˆæƒ"></a>æˆæƒ</h1><p><strong>å¯¹å·²ç»è®¤è¯ï¼ˆç™»å½•ï¼‰æˆåŠŸçš„ç”¨æˆ·ï¼Œåˆ¤æ–­ä»–æ˜¯å¦æœ‰æƒé™è®¿é—®æŸäº›èµ„æºæˆ–æ‰§è¡ŒæŸäº›æ“ä½œ,æˆæƒå‘ç”Ÿåœ¨è®¤è¯ä¹‹åã€‚Spring Security ä¼šæ ¹æ®ç”¨æˆ·çš„æƒé™ï¼ˆ<code>Authorities</code>ï¼‰å’Œè®¿é—®çš„èµ„æºï¼Œå†³å®šæ˜¯å¦æ”¾è¡Œã€‚</strong></p>
<p> ğŸ§  ä¸€å¥è¯ç†è§£æˆæƒæµç¨‹ï¼š</p>
<blockquote>
<p>ç”¨æˆ·æºå¸¦ Token è¯·æ±‚æ¥å£ â†’ JWTFilter æå–ç”¨æˆ·æƒé™ â†’ Security åˆ¤æ–­ç”¨æˆ·æ˜¯å¦æœ‰æƒè®¿é—® URLï¼ˆæˆ–æ–¹æ³•ï¼‰</p>
</blockquote>
<h2 id="ğŸ”-Spring-Security-æˆæƒçš„ä¸‰ç§å¸¸è§æ–¹å¼ï¼š"><a href="#ğŸ”-Spring-Security-æˆæƒçš„ä¸‰ç§å¸¸è§æ–¹å¼ï¼š" class="headerlink" title="ğŸ” Spring Security æˆæƒçš„ä¸‰ç§å¸¸è§æ–¹å¼ï¼š"></a>ğŸ” Spring Security æˆæƒçš„ä¸‰ç§å¸¸è§æ–¹å¼ï¼š</h2><h3 id="âœ…-1-åŸºäº-URL-çš„æˆæƒï¼ˆæ§åˆ¶æ¥å£è®¿é—®æƒé™ï¼‰"><a href="#âœ…-1-åŸºäº-URL-çš„æˆæƒï¼ˆæ§åˆ¶æ¥å£è®¿é—®æƒé™ï¼‰" class="headerlink" title="âœ… 1. åŸºäº URL çš„æˆæƒï¼ˆæ§åˆ¶æ¥å£è®¿é—®æƒé™ï¼‰"></a>âœ… 1. <strong>åŸºäº URL çš„æˆæƒ</strong>ï¼ˆæ§åˆ¶æ¥å£è®¿é—®æƒé™ï¼‰</h3><p>é…ç½®åœ¨ <code>SecurityFilterChain</code> é‡Œçš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">http.authorizeHttpRequests()</span><br><span class="line">    .antMatchers(<span class="string">&quot;/admin/**&quot;</span>).hasRole(<span class="string">&quot;ADMIN&quot;</span>)      <span class="comment">// è®¿é—® /admin å¼€å¤´æ¥å£å¿…é¡»æœ‰ ADMIN è§’è‰²</span></span><br><span class="line">    .antMatchers(<span class="string">&quot;/user/**&quot;</span>).hasAnyAuthority(<span class="string">&quot;user:add&quot;</span>, <span class="string">&quot;user:update&quot;</span>) <span class="comment">// å…·å¤‡ä»»ä¸€æƒé™å¯è®¿é—®</span></span><br><span class="line">    .anyRequest().authenticated();                  <span class="comment">// å…¶ä»–è¯·æ±‚éƒ½è¦ç™»å½•è®¤è¯</span></span><br></pre></td></tr></table></figure>

<p><strong>å¸¸ç”¨æ–¹æ³•:</strong></p>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td><code>.hasAuthority(&quot;æƒé™å&quot;)</code></td>
<td>æ‹¥æœ‰æŸä¸ªå…·ä½“æƒé™</td>
</tr>
<tr>
<td><code>.hasAnyAuthority(...)</code></td>
<td>æ‹¥æœ‰ä»»æ„ä¸€ä¸ªæƒé™å³å¯</td>
</tr>
<tr>
<td><code>.hasRole(&quot;è§’è‰²å&quot;)</code></td>
<td>æ‹¥æœ‰æŸä¸ªè§’è‰²ï¼ˆåº•å±‚å…¶å®æ˜¯åŠ å‰ç¼€ï¼š<code>ROLE_</code>ï¼‰</td>
</tr>
<tr>
<td><code>.hasAnyRole(...)</code></td>
<td>æ‹¥æœ‰ä»»æ„ä¸€ä¸ªè§’è‰²</td>
</tr>
<tr>
<td><code>.authenticated()</code></td>
<td>å·²ç™»å½•ç”¨æˆ·å¯è®¿é—®</td>
</tr>
<tr>
<td><code>.permitAll()</code></td>
<td>æ‰€æœ‰äººéƒ½å¯ä»¥è®¿é—®</td>
</tr>
<tr>
<td><code>.anonymous()</code></td>
<td>åŒ¿åç”¨æˆ·æ‰èƒ½è®¿é—®ï¼ˆæœªç™»å½•ï¼‰</td>
</tr>
</tbody></table>
<hr>
<h3 id="âœ…-2-åŸºäºæ–¹æ³•çš„æˆæƒï¼ˆç²¾ç»†æ§åˆ¶æŸä¸ªæ¥å£æˆ–ä¸šåŠ¡æ–¹æ³•ï¼‰"><a href="#âœ…-2-åŸºäºæ–¹æ³•çš„æˆæƒï¼ˆç²¾ç»†æ§åˆ¶æŸä¸ªæ¥å£æˆ–ä¸šåŠ¡æ–¹æ³•ï¼‰" class="headerlink" title="âœ… 2. åŸºäºæ–¹æ³•çš„æˆæƒï¼ˆç²¾ç»†æ§åˆ¶æŸä¸ªæ¥å£æˆ–ä¸šåŠ¡æ–¹æ³•ï¼‰"></a>âœ… 2. <strong>åŸºäºæ–¹æ³•çš„æˆæƒ</strong>ï¼ˆç²¾ç»†æ§åˆ¶æŸä¸ªæ¥å£æˆ–ä¸šåŠ¡æ–¹æ³•ï¼‰</h3><p>ä½¿ç”¨æ³¨è§£ï¼Œåœ¨ Controller æˆ– Service æ–¹æ³•ä¸Šä½¿ç”¨ï¼š</p>
<p> <strong>å¯ç”¨æ–¹æ³•çº§å®‰å…¨ï¼š</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableMethodSecurity</span> <span class="comment">// Spring Security 6+ æ¨èçš„ï¼ˆè€ç‰ˆæœ¬ç”¨ @EnableGlobalMethodSecurityï¼‰</span></span><br></pre></td></tr></table></figure>

<p> <strong>ç„¶åç”¨æ³¨è§£æ§åˆ¶æƒé™ï¼š</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PreAuthorize(&quot;hasAuthority(&#x27;user:add&#x27;)&quot;)</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/user/add&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">addUser</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;æ·»åŠ ç”¨æˆ·&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>å¸¸ç”¨è¡¨è¾¾å¼ï¼š</strong></p>
<table>
<thead>
<tr>
<th>è¡¨è¾¾å¼</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td><code>hasAuthority(&#39;xxx&#39;)</code></td>
<td>æ‹¥æœ‰æŒ‡å®šæƒé™</td>
</tr>
<tr>
<td><code>hasRole(&#39;ADMIN&#39;)</code></td>
<td>æ‹¥æœ‰æŒ‡å®šè§’è‰²ï¼ˆä¼šè‡ªåŠ¨åŠ  <code>ROLE_</code> å‰ç¼€ï¼‰</td>
</tr>
<tr>
<td><code>hasAnyAuthority(&#39;a&#39;,&#39;b&#39;)</code></td>
<td>æ‹¥æœ‰ä»»ä¸€æƒé™</td>
</tr>
<tr>
<td><code>#id == authentication.principal.id</code></td>
<td>å½“å‰ç”¨æˆ·åªèƒ½æ“ä½œè‡ªå·±çš„æ•°æ®ï¼ˆæ¯”å¦‚åªæ”¹è‡ªå·±çš„èµ„æ–™ï¼‰</td>
</tr>
</tbody></table>
<hr>
<h3 id="âœ…-3-è‡ªå®šä¹‰æƒé™æ ¡éªŒé€»è¾‘"><a href="#âœ…-3-è‡ªå®šä¹‰æƒé™æ ¡éªŒé€»è¾‘" class="headerlink" title="âœ… 3. è‡ªå®šä¹‰æƒé™æ ¡éªŒé€»è¾‘"></a>âœ… 3. <strong>è‡ªå®šä¹‰æƒé™æ ¡éªŒé€»è¾‘</strong></h3><p>å¦‚æœä½ æƒ³å†™ä¸€ä¸ªæ›´åŠ çµæ´»çš„æƒé™åˆ¤æ–­é€»è¾‘ï¼Œå¯ä»¥è‡ªå®šä¹‰æƒé™æ ¡éªŒç»„ä»¶ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component(&quot;myAuth&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAuthorizationService</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">checkPermission</span><span class="params">(Authentication auth, String permission)</span> &#123;</span><br><span class="line">        <span class="comment">// åˆ¤æ–­ auth ä¸­çš„æƒé™åˆ—è¡¨æ˜¯å¦åŒ…å« permission</span></span><br><span class="line">        <span class="keyword">return</span> auth.getAuthorities().stream()</span><br><span class="line">                   .anyMatch(a -&gt; a.getAuthority().equals(permission));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åè¿™æ ·ç”¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PreAuthorize(&quot;@myAuth.checkPermission(authentication, &#x27;user:delete&#x27;)&quot;)</span></span><br></pre></td></tr></table></figure>

<h2 id="å…·ä½“å®ç°-1"><a href="#å…·ä½“å®ç°-1" class="headerlink" title="å…·ä½“å®ç°"></a>å…·ä½“å®ç°</h2><h3 id="é™åˆ¶è®¿é—®èµ„æºæ‰€éœ€æƒé™"><a href="#é™åˆ¶è®¿é—®èµ„æºæ‰€éœ€æƒé™" class="headerlink" title="é™åˆ¶è®¿é—®èµ„æºæ‰€éœ€æƒé™"></a><strong>é™åˆ¶è®¿é—®èµ„æºæ‰€éœ€æƒé™</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;hasAuthority(&#x27;test&#x27;)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="å°è£…æƒé™ä¿¡æ¯"><a href="#å°è£…æƒé™ä¿¡æ¯" class="headerlink" title="å°è£…æƒé™ä¿¡æ¯"></a><strong>å°è£…æƒé™ä¿¡æ¯</strong></h3><p>å°è£…æƒé™ä¿¡æ¯åˆ°LoginUser</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginUser</span> <span class="keyword">implements</span> <span class="title class_">UserDetails</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> User user;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">//å­˜å‚¨æƒé™ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; permissions;</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LoginUser</span><span class="params">(User user,List&lt;String&gt; permissions)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.user = user;</span><br><span class="line">        <span class="built_in">this</span>.permissions = permissions;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//å­˜å‚¨SpringSecurityæ‰€éœ€è¦çš„æƒé™ä¿¡æ¯çš„é›†åˆ</span></span><br><span class="line">    <span class="meta">@JSONField(serialize = false)</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;GrantedAuthority&gt; authorities;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span>  Collection&lt;? <span class="keyword">extends</span> <span class="title class_">GrantedAuthority</span>&gt; getAuthorities() &#123;</span><br><span class="line">        <span class="keyword">if</span>(authorities!=<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> authorities;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//æŠŠpermissionsä¸­å­—ç¬¦ä¸²ç±»å‹çš„æƒé™ä¿¡æ¯è½¬æ¢æˆGrantedAuthorityå¯¹è±¡å­˜å…¥authoritiesä¸­</span></span><br><span class="line">        authorities = permissions.stream().</span><br><span class="line">                map(SimpleGrantedAuthority::<span class="keyword">new</span>)</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">        <span class="keyword">return</span> authorities;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPassword</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> user.getPassword();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUsername</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> user.getUserName();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isAccountNonExpired</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isAccountNonLocked</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isCredentialsNonExpired</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isEnabled</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>åœ¨UserDetailsServiceImplä¸­å»æŠŠæƒé™ä¿¡æ¯å°è£…åˆ°LoginUserä¸­äº†</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserDetailsServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">UserDetailsService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> UserDetails <span class="title function_">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException &#123;</span><br><span class="line">        LambdaQueryWrapper&lt;User&gt; wrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">        wrapper.eq(User::getUserName,username);</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userMapper.selectOne(wrapper);</span><br><span class="line">        <span class="keyword">if</span>(Objects.isNull(user))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ ¹æ®ç”¨æˆ·æŸ¥è¯¢æƒé™ä¿¡æ¯ æ·»åŠ åˆ°LoginUserä¸­</span></span><br><span class="line">        List&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(Arrays.asList(<span class="string">&quot;test&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LoginUser</span>(user,list);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å»JwtAuthenticationTokenFilterç±»ä¸­æŠŠç”¨æˆ·ä¸­çš„authoritiesæƒé™å°è£…åˆ°UsernamePasswordAuthenticationTokenä¸­ï¼Œç„¶åäº¤ç»™SecurityContextHolderã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å­˜å…¥SecurityContextHolder</span></span><br><span class="line"><span class="comment">// è·å–æƒé™ä¿¡æ¯å°è£…åˆ° setAuthentication ä¸­</span></span><br><span class="line"><span class="type">UsernamePasswordAuthenticationToken</span> <span class="variable">usernamePasswordAuthenticationToken</span> <span class="operator">=</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(loginUser, <span class="literal">null</span>, loginUser.getAuthorities());</span><br><span class="line">SecurityContextHolder.getContext().setAuthentication(usernamePasswordAuthenticationToken);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="ä»æ•°æ®åº“æŸ¥è¯¢æƒé™ä¿¡æ¯"><a href="#ä»æ•°æ®åº“æŸ¥è¯¢æƒé™ä¿¡æ¯" class="headerlink" title="ä»æ•°æ®åº“æŸ¥è¯¢æƒé™ä¿¡æ¯"></a>ä»æ•°æ®åº“æŸ¥è¯¢æƒé™ä¿¡æ¯</h3><p>RBACæƒé™æ¨¡å‹ï¼ˆRole-Based Access Controlï¼‰å³ï¼šåŸºäºè§’è‰²çš„æƒé™æ§åˆ¶ã€‚è¿™æ˜¯ç›®å‰æœ€å¸¸è¢«å¼€å‘è€…ä½¿ç”¨ä¹Ÿæ˜¯ç›¸å¯¹æ˜“ç”¨ã€é€šç”¨æƒé™æ¨¡å‹ã€‚</p>
<img src="https://cdn.jsdelivr.net/gh/KNeegcyao/picdemo/img/2627855816.png" alt="img" style="zoom:50%;" />

<img src="https://cdn.jsdelivr.net/gh/KNeegcyao/picdemo/img/image-20250405231327498.png" alt="img" style="zoom:67%;" />

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * èœå•è¡¨(Menu)å®ä½“ç±»</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> makejava</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2021-11-24 15:30:08</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@TableName(value=&quot;sys_menu&quot;)</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@JsonInclude(JsonInclude.Include.NON_NULL)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Menu</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">54979041104113736L</span>;</span><br><span class="line">  </span><br><span class="line">        <span class="meta">@TableId</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * èœå•å</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">private</span> String menuName;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * è·¯ç”±åœ°å€</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">private</span> String path;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * ç»„ä»¶è·¯å¾„</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">private</span> String component;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * èœå•çŠ¶æ€ï¼ˆ0æ˜¾ç¤º 1éšè—ï¼‰</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">private</span> String visible;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * èœå•çŠ¶æ€ï¼ˆ0æ­£å¸¸ 1åœç”¨ï¼‰</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">private</span> String status;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * æƒé™æ ‡è¯†</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">private</span> String perms;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * èœå•å›¾æ ‡</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">private</span> String icon;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> Long createBy;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> Long updateBy;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> Date updateTime;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * æ˜¯å¦åˆ é™¤ï¼ˆ0æœªåˆ é™¤ 1å·²åˆ é™¤ï¼‰</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">private</span> Integer delFlag;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * å¤‡æ³¨</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">private</span> String remark;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> sys_menu</span><br><span class="line">(</span><br><span class="line">    id          <span class="type">bigint</span> auto_increment</span><br><span class="line">        <span class="keyword">primary</span> key,</span><br><span class="line">    menu_name   <span class="type">varchar</span>(<span class="number">64</span>)  <span class="keyword">default</span> <span class="string">&#x27;NULL&#x27;</span> <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;èœå•å&#x27;</span>,</span><br><span class="line">    path        <span class="type">varchar</span>(<span class="number">200</span>)                <span class="keyword">null</span> comment <span class="string">&#x27;è·¯ç”±åœ°å€&#x27;</span>,</span><br><span class="line">    component   <span class="type">varchar</span>(<span class="number">255</span>)                <span class="keyword">null</span> comment <span class="string">&#x27;ç»„ä»¶è·¯å¾„&#x27;</span>,</span><br><span class="line">    visible     <span class="type">char</span>         <span class="keyword">default</span> <span class="string">&#x27;0&#x27;</span>    <span class="keyword">null</span> comment <span class="string">&#x27;èœå•çŠ¶æ€ï¼ˆ0æ˜¾ç¤º 1éšè—ï¼‰&#x27;</span>,</span><br><span class="line">    status      <span class="type">char</span>         <span class="keyword">default</span> <span class="string">&#x27;0&#x27;</span>    <span class="keyword">null</span> comment <span class="string">&#x27;èœå•çŠ¶æ€ï¼ˆ0æ­£å¸¸ 1åœç”¨ï¼‰&#x27;</span>,</span><br><span class="line">    perms       <span class="type">varchar</span>(<span class="number">100</span>)                <span class="keyword">null</span> comment <span class="string">&#x27;æƒé™æ ‡è¯†&#x27;</span>,</span><br><span class="line">    icon        <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">default</span> <span class="string">&#x27;#&#x27;</span>    <span class="keyword">null</span> comment <span class="string">&#x27;èœå•å›¾æ ‡&#x27;</span>,</span><br><span class="line">    create_by   <span class="type">bigint</span>                      <span class="keyword">null</span>,</span><br><span class="line">    create_time datetime                    <span class="keyword">null</span>,</span><br><span class="line">    update_by   <span class="type">bigint</span>                      <span class="keyword">null</span>,</span><br><span class="line">    update_time datetime                    <span class="keyword">null</span>,</span><br><span class="line">    del_flag    <span class="type">int</span>          <span class="keyword">default</span> <span class="number">0</span>      <span class="keyword">null</span> comment <span class="string">&#x27;æ˜¯å¦åˆ é™¤ï¼ˆ0æœªåˆ é™¤ 1å·²åˆ é™¤ï¼‰&#x27;</span>,</span><br><span class="line">    remark      <span class="type">varchar</span>(<span class="number">500</span>)                <span class="keyword">null</span> comment <span class="string">&#x27;å¤‡æ³¨&#x27;</span></span><br><span class="line">)</span><br><span class="line">    comment <span class="string">&#x27;èœå•è¡¨&#x27;</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="æ¥å£å…·ä½“å®ç°"><a href="#æ¥å£å…·ä½“å®ç°" class="headerlink" title="æ¥å£å…·ä½“å®ç°"></a>æ¥å£å…·ä½“å®ç°</h3><p>mapperå±‚å®ç°</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MenuMapper</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;Menu&gt; &#123;</span><br><span class="line">    List&lt;String&gt; <span class="title function_">selectPermsByUserId</span><span class="params">(Long id)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span> <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span> <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.example.mapper.MenuMapper&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectPermsByUserId&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;java.lang.String&quot;</span>&gt;</span></span><br><span class="line">        SELECT</span><br><span class="line">            DISTINCT m.`perms`</span><br><span class="line">        FROM</span><br><span class="line">            sys_user_role ur</span><br><span class="line">            LEFT JOIN `sys_role` r ON ur.`role_id` = r.`id`</span><br><span class="line">            LEFT JOIN `sys_role_menu` rm ON ur.`role_id` = rm.`role_id`</span><br><span class="line">            LEFT JOIN `sys_menu` m ON m.`id` = rm.`menu_id`</span><br><span class="line">        WHERE</span><br><span class="line">            user_id = #&#123;userid&#125;</span><br><span class="line">            AND r.`status` = 0</span><br><span class="line">            AND m.`status` = 0</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å®Œå–„UserServiceImpl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserDetailsServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">UserDetailsService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MenuMapper menuMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> UserDetails <span class="title function_">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException &#123;</span><br><span class="line">        LambdaQueryWrapper&lt;User&gt; wrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">        wrapper.eq(User::getUserName,username);</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userMapper.selectOne(wrapper);</span><br><span class="line">        <span class="keyword">if</span>(Objects.isNull(user))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;String&gt; permissionKeyList =  menuMapper.selectPermsByUserId(user.getId());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LoginUser</span>(user,permissionKeyList);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<h1 id="è‡ªå®šä¹‰å¤±è´¥å¤„ç†"><a href="#è‡ªå®šä¹‰å¤±è´¥å¤„ç†" class="headerlink" title="è‡ªå®šä¹‰å¤±è´¥å¤„ç†"></a>è‡ªå®šä¹‰å¤±è´¥å¤„ç†</h1><h2 id="å¼‚å¸¸æ‹¦æˆªç‚¹ï¼šExceptionTranslationFilter"><a href="#å¼‚å¸¸æ‹¦æˆªç‚¹ï¼šExceptionTranslationFilter" class="headerlink" title="å¼‚å¸¸æ‹¦æˆªç‚¹ï¼šExceptionTranslationFilter"></a>å¼‚å¸¸æ‹¦æˆªç‚¹ï¼šExceptionTranslationFilter</h2><ul>
<li><strong>èŒè´£</strong>ï¼šåœ¨è¿‡æ»¤å™¨é“¾ä¸­ä¸“é—¨æ•è·è®¤è¯æˆ–æˆæƒè¿‡ç¨‹ä¸­æŠ›å‡ºçš„å¼‚å¸¸ã€‚</li>
<li><strong>å·¥ä½œæµç¨‹</strong>ï¼š<ol>
<li>å½“è®¤è¯ï¼ˆAuthenticationï¼‰æˆ–æˆæƒï¼ˆAuthorizationï¼‰å¤±è´¥æ—¶ï¼Œç›¸å…³çš„è¿‡æ»¤å™¨ï¼ˆå¦‚ <code>UsernamePasswordAuthenticationFilter</code>ã€<code>FilterSecurityInterceptor</code>ï¼‰ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</li>
<li><code>ExceptionTranslationFilter</code> æ•è·è¿™äº›å¼‚å¸¸ï¼Œåˆ¤æ–­æ˜¯è®¤è¯å¤±è´¥è¿˜æ˜¯æˆæƒå¤±è´¥ã€‚</li>
<li>æ ¹æ®å¼‚å¸¸ç±»å‹åˆ†åˆ«äº¤ç»™ <strong><code>AuthenticationEntryPoint</code></strong> æˆ– <strong><code>AccessDeniedHandler</code></strong> å»å¤„ç†ã€‚</li>
</ol>
</li>
</ul>
<hr>
<h2 id="è®¤è¯å¤±è´¥-vs-æˆæƒå¤±è´¥"><a href="#è®¤è¯å¤±è´¥-vs-æˆæƒå¤±è´¥" class="headerlink" title="è®¤è¯å¤±è´¥ vs æˆæƒå¤±è´¥"></a>è®¤è¯å¤±è´¥ vs æˆæƒå¤±è´¥</h2><table>
<thead>
<tr>
<th>å¼‚å¸¸ç±»å‹</th>
<th>åœºæ™¯</th>
<th>é»˜è®¤å¤„ç†</th>
</tr>
</thead>
<tbody><tr>
<td><strong>AuthenticationException</strong></td>
<td>ç”¨æˆ·æœªç™»å½•ã€ç™»å½•å‡­è¯ï¼ˆç”¨æˆ·å&#x2F;å¯†ç ã€Tokenï¼‰ä¸åˆæ³•</td>
<td>è°ƒç”¨ <code>AuthenticationEntryPoint.commence()</code>ï¼Œé»˜è®¤é‡å®šå‘åˆ°ç™»å½•é¡µé¢æˆ–è¿”å› 401</td>
</tr>
<tr>
<td><strong>AccessDeniedException</strong></td>
<td>ç”¨æˆ·å·²ç™»å½•ï¼Œä½†æ²¡æœ‰è®¿é—®æŸä¸ªèµ„æºçš„æƒé™ï¼ˆè§’è‰²&#x2F;æƒé™ä¸è¶³ï¼‰</td>
<td>è°ƒç”¨ <code>AccessDeniedHandler.handle()</code>ï¼Œé»˜è®¤è¿”å› 403 é¡µé¢æˆ–é”™è¯¯å“åº”</td>
</tr>
</tbody></table>
<hr>
<h2 id="è‡ªå®šä¹‰å¤„ç†å™¨"><a href="#è‡ªå®šä¹‰å¤„ç†å™¨" class="headerlink" title="è‡ªå®šä¹‰å¤„ç†å™¨"></a>è‡ªå®šä¹‰å¤„ç†å™¨</h2><h3 id="è‡ªå®šä¹‰-AuthenticationEntryPoint"><a href="#è‡ªå®šä¹‰-AuthenticationEntryPoint" class="headerlink" title="è‡ªå®šä¹‰ AuthenticationEntryPoint"></a>è‡ªå®šä¹‰ <code>AuthenticationEntryPoint</code></h3><p>å½“æ•è·åˆ° <code>AuthenticationException</code> æ—¶ä¼šèµ°è¿™é‡Œï¼Œé€šå¸¸ç”¨äºâ€œæœªç™»å½•â€æˆ–â€œToken æ— æ•ˆâ€åœºæ™¯ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthenticationEntryPointImpl</span> <span class="keyword">implements</span> <span class="title class_">AuthenticationEntryPoint</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">commence</span><span class="params">(HttpServletRequest request,</span></span><br><span class="line"><span class="params">                         HttpServletResponse response,</span></span><br><span class="line"><span class="params">                         AuthenticationException authException)</span></span><br><span class="line">                         <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        <span class="comment">// æ„é€ ç»Ÿä¸€çš„ JSON å“åº”ä½“</span></span><br><span class="line">        <span class="type">ResponseResult</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResponseResult</span>(</span><br><span class="line">            HttpStatus.UNAUTHORIZED.value(), </span><br><span class="line">            <span class="string">&quot;è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•&quot;</span></span><br><span class="line">        );</span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> JSON.toJSONString(result);</span><br><span class="line">        <span class="comment">// ç›´æ¥å°† JSON å†™å›å“åº”</span></span><br><span class="line">        WebUtils.renderString(response, json);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong><code>commence()</code> æ–¹æ³•</strong>ï¼š<ul>
<li><code>response</code>ï¼šç›´æ¥å¾€ HTTP å“åº”é‡Œå†™çŠ¶æ€ç å’Œ JSONï¼Œå‰ç«¯å¯ä»¥æ ¹æ®ç»“æ„åŒ–æ•°æ®ç»Ÿä¸€å¤„ç†ã€‚</li>
<li><code>ResponseResult</code>ï¼šä½ çš„ç»Ÿä¸€å“åº”å¯¹è±¡ï¼ŒåŒ…å« <code>code</code>ã€<code>msg</code>ã€<code>data</code> ç­‰å­—æ®µã€‚</li>
<li><code>WebUtils.renderString()</code>ï¼šå·¥å…·æ–¹æ³•ï¼Œè®¾ç½®å“åº”ç±»å‹ä¸º <code>application/json</code> å¹¶å†™å…¥å­—ç¬¦ä¸²ã€‚</li>
</ul>
</li>
</ul>
<h3 id="è‡ªå®šä¹‰-AccessDeniedHandler"><a href="#è‡ªå®šä¹‰-AccessDeniedHandler" class="headerlink" title="è‡ªå®šä¹‰ AccessDeniedHandler"></a>è‡ªå®šä¹‰ <code>AccessDeniedHandler</code></h3><p>å½“æ•è·åˆ° <code>AccessDeniedException</code> æ—¶ä¼šèµ°è¿™é‡Œï¼Œé€šå¸¸ç”¨äºâ€œæƒé™ä¸è¶³â€åœºæ™¯ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccessDeniedHandlerImpl</span> <span class="keyword">implements</span> <span class="title class_">AccessDeniedHandler</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(HttpServletRequest request,</span></span><br><span class="line"><span class="params">                       HttpServletResponse response,</span></span><br><span class="line"><span class="params">                       AccessDeniedException accessDeniedException)</span></span><br><span class="line">                       <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        <span class="type">ResponseResult</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResponseResult</span>(</span><br><span class="line">            HttpStatus.FORBIDDEN.value(), </span><br><span class="line">            <span class="string">&quot;æƒé™ä¸è¶³&quot;</span></span><br><span class="line">        );</span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> JSON.toJSONString(result);</span><br><span class="line">        WebUtils.renderString(response, json);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong><code>handle()</code> æ–¹æ³•</strong>ï¼š<ul>
<li>åŒæ ·æ„é€ ç»Ÿä¸€çš„ JSON å“åº”å¹¶å†™å›ï¼ŒçŠ¶æ€ç ä½¿ç”¨ 403ï¼ˆForbiddenï¼‰ã€‚</li>
</ul>
</li>
</ul>
<hr>
<h2 id="å°†è‡ªå®šä¹‰å¤„ç†å™¨æ³¨å…¥åˆ°-Spring-Security"><a href="#å°†è‡ªå®šä¹‰å¤„ç†å™¨æ³¨å…¥åˆ°-Spring-Security" class="headerlink" title="å°†è‡ªå®šä¹‰å¤„ç†å™¨æ³¨å…¥åˆ° Spring Security"></a>å°†è‡ªå®šä¹‰å¤„ç†å™¨æ³¨å…¥åˆ° Spring Security</h2><p>åœ¨ä½ çš„ <code>HttpSecurity</code> é…ç½®ä¸­ï¼Œè°ƒç”¨ <code>exceptionHandling()</code> æ–¹æ³•å°†å®ƒä»¬æ³¨å†Œè¿›å»ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AuthenticationEntryPointImpl authenticationEntryPoint;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AccessDeniedHandlerImpl accessDeniedHandler;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SecurityFilterChain <span class="title function_">securityFilterChain</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http</span><br><span class="line">          <span class="comment">// ... å…¶ä»–é…ç½® ...</span></span><br><span class="line">          .exceptionHandling()</span><br><span class="line">            .authenticationEntryPoint(authenticationEntryPoint)  <span class="comment">// è®¤è¯å¤±è´¥å¤„ç†</span></span><br><span class="line">            .accessDeniedHandler(accessDeniedHandler)            <span class="comment">// æˆæƒå¤±è´¥å¤„ç†</span></span><br><span class="line">          <span class="comment">// ... ç»§ç»­ä½ çš„è¿‡æ»¤é“¾é…ç½® ...</span></span><br><span class="line">        ;</span><br><span class="line">        <span class="keyword">return</span> http.build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>**<code>authenticationEntryPoint(...)</code>**ï¼šæŒ‡å®šå½“å‡ºç° <code>AuthenticationException</code> æ—¶è°ƒç”¨å“ªä¸ª Beanã€‚</li>
<li>**<code>accessDeniedHandler(...)</code>**ï¼šæŒ‡å®šå½“å‡ºç° <code>AccessDeniedException</code> æ—¶è°ƒç”¨å“ªä¸ª Beanã€‚</li>
</ul>
<h1 id="è·¨åŸŸ"><a href="#è·¨åŸŸ" class="headerlink" title="è·¨åŸŸ"></a>è·¨åŸŸ</h1><h2 id="ä»€ä¹ˆæ˜¯è·¨åŸŸï¼ˆCORSï¼‰ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯è·¨åŸŸï¼ˆCORSï¼‰ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯è·¨åŸŸï¼ˆCORSï¼‰ï¼Ÿ"></a>ä»€ä¹ˆæ˜¯è·¨åŸŸï¼ˆCORSï¼‰ï¼Ÿ</h2><ul>
<li><strong>åŒæºç­–ç•¥</strong>ï¼šæµè§ˆå™¨å‡ºäºå®‰å…¨è€ƒè™‘ï¼Œåªæœ‰å½“ åè®®ã€åŸŸåã€ç«¯å£ ä¸‰è€…éƒ½ç›¸åŒæ—¶ï¼Œæ‰èƒ½æ­£å¸¸å‘èµ· AJAX è¯·æ±‚ã€‚</li>
<li><strong>è·¨åŸŸåœºæ™¯</strong>ï¼šå‰åç«¯åˆ†ç¦»æ—¶ï¼Œå‰ç«¯é€šå¸¸è·‘åœ¨ <code>http://localhost:3000</code>ï¼Œåç«¯åœ¨ <code>http://localhost:8080</code>ï¼Œç«¯å£ä¸åŒï¼Œå°±å±äºè·¨åŸŸã€‚</li>
<li><strong>CORS</strong>ï¼ˆCrossâ€‘Origin Resource Sharingï¼‰æœºåˆ¶å…è®¸æœåŠ¡å™¨å£°æ˜ï¼šå“ªäº›åŸŸåã€å“ªäº›æ–¹æ³•ã€å“ªäº›è¯·æ±‚å¤´å¯ä»¥è®¿é—®å®ƒçš„èµ„æºã€‚</li>
</ul>
<hr>
<h2 id="Spring-MVC-å±‚é¢å…è®¸è·¨åŸŸ"><a href="#Spring-MVC-å±‚é¢å…è®¸è·¨åŸŸ" class="headerlink" title="Spring MVC å±‚é¢å…è®¸è·¨åŸŸ"></a>Spring MVC å±‚é¢å…è®¸è·¨åŸŸ</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CorsConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addCorsMappings</span><span class="params">(CorsRegistry registry)</span> &#123;</span><br><span class="line">        registry.addMapping(<span class="string">&quot;/**&quot;</span>)               <span class="comment">// â‘  å¯¹æ‰€æœ‰æ¥å£éƒ½å…è®¸è·¨åŸŸ</span></span><br><span class="line">                .allowedOriginPatterns(<span class="string">&quot;*&quot;</span>)      <span class="comment">// â‘¡ å…è®¸ä»»æ„åŸŸåå‘èµ·è·¨åŸŸè¯·æ±‚ï¼ˆä¹Ÿå¯ä»¥å†™å…·ä½“åŸŸååˆ—è¡¨ï¼‰</span></span><br><span class="line">                .allowCredentials(<span class="literal">true</span>)          <span class="comment">// â‘¢ å…è®¸æºå¸¦ Cookieï¼ˆå¦‚æœå‰ç«¯è¦å‘é€æˆ–æ¥æ”¶ cookieï¼Œå¿…é¡»å¼€å¯ï¼‰</span></span><br><span class="line">                .allowedMethods(<span class="string">&quot;GET&quot;</span>,<span class="string">&quot;POST&quot;</span>,<span class="string">&quot;DELETE&quot;</span>,<span class="string">&quot;PUT&quot;</span>) <span class="comment">// â‘£ å…è®¸çš„æ–¹æ³•</span></span><br><span class="line">                .allowedHeaders(<span class="string">&quot;*&quot;</span>)            <span class="comment">// â‘¤ å…è®¸çš„è¯·æ±‚å¤´</span></span><br><span class="line">                .maxAge(<span class="number">3600</span>);                  <span class="comment">// â‘¥ é¢„æ£€è¯·æ±‚çš„ç¼“å­˜æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œåœ¨è¿™æ®µæ—¶é—´å†…æµè§ˆå™¨ä¸å†å‘ç¬¬äºŒæ¬¡é¢„æ£€</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>ä¸ºä»€ä¹ˆè¦ MVC é…ç½®ï¼Ÿ</strong><br>Spring MVC é»˜è®¤ä¼šæ³¨å†Œä¸€ä¸ª <code>CorsFilter</code>ï¼Œå®ƒæ ¹æ®ä¸Šé¢çš„è§„åˆ™å“åº”æµè§ˆå™¨çš„ <strong>é¢„æ£€è¯·æ±‚</strong>ï¼ˆ<code>OPTIONS</code>ï¼‰ï¼Œå¹¶åœ¨å®é™…è¯·æ±‚ä¸­åŠ ä¸Šç›¸åº”çš„ CORS å“åº”å¤´ã€‚</li>
</ul>
<hr>
<h2 id="Spring-Security-å±‚é¢å…è®¸è·¨åŸŸ"><a href="#Spring-Security-å±‚é¢å…è®¸è·¨åŸŸ" class="headerlink" title="Spring Security å±‚é¢å…è®¸è·¨åŸŸ"></a>Spring Security å±‚é¢å…è®¸è·¨åŸŸ</h2><p>å³ä½¿ä½ åœ¨ MVC å±‚é¢é…ç½®äº† CORSï¼ŒSpring Security é»˜è®¤ä¹Ÿä¼šæ‹¦æˆªæ‰€æœ‰è¯·æ±‚ï¼ˆåŒ…æ‹¬ <code>OPTIONS</code> é¢„æ£€ï¼‰ï¼Œå¯¼è‡´é¢„æ£€è¢«æ‹’ç»ã€‚<br> æ‰€ä»¥åœ¨ä½ çš„å®‰å…¨é…ç½®é‡Œï¼Œè¿˜è¦<strong>æ˜¾å¼å¼€å¯</strong> CORS æ”¯æŒï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http</span><br><span class="line">                <span class="comment">//å…³é—­csrf</span></span><br><span class="line">                .csrf().disable()</span><br><span class="line">                <span class="comment">//ä¸é€šè¿‡Sessionè·å–SecurityContext</span></span><br><span class="line">                .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS)</span><br><span class="line">                .and()</span><br><span class="line">                .authorizeRequests()</span><br><span class="line">                <span class="comment">// å¯¹äºç™»å½•æ¥å£ å…è®¸åŒ¿åè®¿é—®</span></span><br><span class="line">                .antMatchers(<span class="string">&quot;/user/login&quot;</span>).anonymous()</span><br><span class="line">                <span class="comment">// é™¤ä¸Šé¢å¤–çš„æ‰€æœ‰è¯·æ±‚å…¨éƒ¨éœ€è¦é‰´æƒè®¤è¯</span></span><br><span class="line">                .anyRequest().authenticated();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//æ·»åŠ è¿‡æ»¤å™¨</span></span><br><span class="line">        http.addFilterBefore(jwtAuthenticationTokenFilter, UsernamePasswordAuthenticationFilter.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//é…ç½®å¼‚å¸¸å¤„ç†å™¨</span></span><br><span class="line">        http.exceptionHandling()</span><br><span class="line">                <span class="comment">//é…ç½®è®¤è¯å¤±è´¥å¤„ç†å™¨</span></span><br><span class="line">                .authenticationEntryPoint(authenticationEntryPoint)</span><br><span class="line">                .accessDeniedHandler(accessDeniedHandler);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//å…è®¸è·¨åŸŸ</span></span><br><span class="line">        http.cors();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><strong><code>http.cors()</code></strong><br>å®ƒä¼šè®© Spring Security å»æŸ¥æ‰¾ Spring MVC ä¸­çš„ <code>CorsConfiguration</code>ï¼ˆå³ä¸Šé¢ <code>CorsConfig</code> å®šä¹‰çš„è§„åˆ™ï¼‰ï¼Œå¹¶åœ¨ SecurityFilterChain çš„æœ€å‰é¢æ’å…¥ä¸€ä¸ª <code>CorsFilter</code>ã€‚</li>
<li><strong>æ•ˆæœ</strong>ï¼š<ul>
<li><strong>é¢„æ£€è¯·æ±‚ï¼ˆOPTIONSï¼‰</strong> å…ˆç»è¿‡ CORS è¿‡æ»¤å™¨ï¼Œè¿”å›å…è®¸çš„è·¨åŸŸå“åº”å¤´ï¼Œæµè§ˆå™¨æ‰ä¼šç»§ç»­å‘çœŸæ­£çš„è¯·æ±‚ã€‚</li>
<li><strong>å®é™…è¯·æ±‚</strong> ä¹Ÿä¼šå¸¦ä¸Š <code>Access-Control-Allow-Origin</code>ã€<code>Access-Control-Allow-Credentials</code> ç­‰å¤´ï¼Œæµè§ˆå™¨æ‰å…è®¸å‰ç«¯ JS è®¿é—®å“åº”å†…å®¹ã€‚</li>
</ul>
</li>
</ul>
<hr>
<h2 id="ä¸ºä»€ä¹ˆä¸¤å¤„éƒ½è¦é…ç½®ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆä¸¤å¤„éƒ½è¦é…ç½®ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆä¸¤å¤„éƒ½è¦é…ç½®ï¼Ÿ"></a>ä¸ºä»€ä¹ˆä¸¤å¤„éƒ½è¦é…ç½®ï¼Ÿ</h2><ol>
<li><strong>MVC å±‚</strong>ï¼šè´Ÿè´£ <strong>å®šä¹‰</strong> å“ªäº›è·¯å¾„ã€å“ªäº›åŸŸåã€å“ªäº›æ–¹æ³•å¯ä»¥è·¨åŸŸã€‚</li>
<li><strong>Security å±‚</strong>ï¼šè´Ÿè´£ <strong>å…è®¸</strong> Spring Security è¿‡æ»¤é“¾é‡Œä¹Ÿæ‰§è¡Œè¿™å¥—è·¨åŸŸè§„åˆ™ï¼Œå¦åˆ™æ‰€æœ‰è·¨åŸŸè¯·æ±‚ï¼ˆåŒ…æ‹¬é¢„æ£€ï¼‰éƒ½ä¼šè¢« Security æ‹¦æˆªæˆ 401&#x2F;403ã€‚</li>
</ol>
<hr>
<h1 id="è‡ªå®šä¹‰å¤„ç†å™¨-1"><a href="#è‡ªå®šä¹‰å¤„ç†å™¨-1" class="headerlink" title="è‡ªå®šä¹‰å¤„ç†å™¨"></a>è‡ªå®šä¹‰å¤„ç†å™¨</h1><h2 id="è®¤è¯æˆåŠŸå¤„ç†å™¨"><a href="#è®¤è¯æˆåŠŸå¤„ç†å™¨" class="headerlink" title="è®¤è¯æˆåŠŸå¤„ç†å™¨"></a>è®¤è¯æˆåŠŸå¤„ç†å™¨</h2><p>å®é™…ä¸Šåœ¨UsernamePasswordAuthenticationFilterè¿›è¡Œç™»å½•è®¤è¯çš„æ—¶å€™ï¼Œå¦‚æœç™»å½•æˆåŠŸäº†æ˜¯ä¼šè°ƒç”¨AuthenticationSuccessHandlerçš„æ–¹æ³•è¿›è¡Œè®¤è¯æˆåŠŸåçš„å¤„ç†çš„ã€‚AuthenticationSuccessHandlerå°±æ˜¯ç™»å½•æˆåŠŸå¤„ç†å™¨ã€‚</p>
<p>æˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå·±å»è‡ªå®šä¹‰æˆåŠŸå¤„ç†å™¨è¿›è¡ŒæˆåŠŸåçš„ç›¸åº”å¤„ç†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SGSuccessHandler</span> <span class="keyword">implements</span> <span class="title class_">AuthenticationSuccessHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAuthenticationSuccess</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;è®¤è¯æˆåŠŸäº†&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AuthenticationSuccessHandler successHandler;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.formLogin().successHandler(successHandler);</span><br><span class="line"></span><br><span class="line">        http.authorizeRequests().anyRequest().authenticated();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="è®¤è¯å¤±è´¥å¤„ç†å™¨"><a href="#è®¤è¯å¤±è´¥å¤„ç†å™¨" class="headerlink" title="è®¤è¯å¤±è´¥å¤„ç†å™¨"></a>è®¤è¯å¤±è´¥å¤„ç†å™¨</h2><p>å®é™…ä¸Šåœ¨UsernamePasswordAuthenticationFilterè¿›è¡Œç™»å½•è®¤è¯çš„æ—¶å€™ï¼Œå¦‚æœè®¤è¯å¤±è´¥äº†æ˜¯ä¼šè°ƒç”¨AuthenticationFailureHandlerçš„æ–¹æ³•è¿›è¡Œè®¤è¯å¤±è´¥åçš„å¤„ç†çš„ã€‚AuthenticationFailureHandlerå°±æ˜¯ç™»å½•å¤±è´¥å¤„ç†å™¨ã€‚</p>
<p>æˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå·±å»è‡ªå®šä¹‰å¤±è´¥å¤„ç†å™¨è¿›è¡Œå¤±è´¥åçš„ç›¸åº”å¤„ç†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SGFailureHandler</span> <span class="keyword">implements</span> <span class="title class_">AuthenticationFailureHandler</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAuthenticationFailure</span><span class="params">(HttpServletRequest request, HttpServletResponse response, AuthenticationException exception)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;è®¤è¯å¤±è´¥äº†&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AuthenticationSuccessHandler successHandler;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AuthenticationFailureHandler failureHandler;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.formLogin()</span><br><span class="line"><span class="comment">//                é…ç½®è®¤è¯æˆåŠŸå¤„ç†å™¨</span></span><br><span class="line">                .successHandler(successHandler)</span><br><span class="line"><span class="comment">//                é…ç½®è®¤è¯å¤±è´¥å¤„ç†å™¨</span></span><br><span class="line">                .failureHandler(failureHandler);</span><br><span class="line"></span><br><span class="line">        http.authorizeRequests().anyRequest().authenticated();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>âš ï¸æ³¨æ„ï¼š</strong>è¿™å’Œä¹‹å‰çš„<code>AuthenticationEntryPoint</code>ä¸¤ä¸ªç±»è™½ç„¶éƒ½æ˜¯å¤„ç† <strong>è®¤è¯å¤±è´¥</strong> çš„æƒ…å†µï¼Œä½†å®ƒä»¬çš„ä½œç”¨åœºæ™¯æ˜¯å®Œå…¨ä¸åŒçš„</p>
<p><strong>æ€»ç»“åŒºåˆ«:</strong></p>
<table>
<thead>
<tr>
<th>æ¯”è¾ƒé¡¹</th>
<th><code>AuthenticationEntryPoint</code></th>
<th><code>AuthenticationFailureHandler</code></th>
</tr>
</thead>
<tbody><tr>
<td>æ‰€åœ¨é˜¶æ®µ</td>
<td>ç”¨æˆ·è®¿é—®å—ä¿æŠ¤èµ„æºä½†æœªç™»å½•</td>
<td>ç”¨æˆ·ç™»å½•æ—¶è¾“å…¥é”™è¯¯</td>
</tr>
<tr>
<td>å‡ºå‘åŸå› </td>
<td>è¯·æ±‚æ¥å£æ²¡å¸¦ tokenã€token æ— æ•ˆ</td>
<td>ç™»å½•æ¥å£ç”¨æˆ·å&#x2F;å¯†ç é”™è¯¯</td>
</tr>
<tr>
<td>å“åº”æ–¹å¼</td>
<td>é€šå¸¸è¿”å› 401ï¼ˆæœªè®¤è¯ï¼‰</td>
<td>é€šå¸¸è¿”å› 401ï¼ˆç™»å½•å¤±è´¥ï¼‰æˆ–ä¸šåŠ¡è‡ªå®šä¹‰çŠ¶æ€ç </td>
</tr>
<tr>
<td>æ³¨å†Œä½ç½®</td>
<td><code>http.exceptionHandling().authenticationEntryPoint(...)</code></td>
<td>ç™»å½•è¿‡æ»¤å™¨ <code>UsernamePasswordAuthenticationFilter</code> çš„ <code>setAuthenticationFailureHandler(...)</code> æ–¹æ³•</td>
</tr>
</tbody></table>
<h2 id="ç™»å‡ºæˆåŠŸå¤„ç†å™¨"><a href="#ç™»å‡ºæˆåŠŸå¤„ç†å™¨" class="headerlink" title="ç™»å‡ºæˆåŠŸå¤„ç†å™¨"></a>ç™»å‡ºæˆåŠŸå¤„ç†å™¨</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SGLogoutSuccessHandler</span> <span class="keyword">implements</span> <span class="title class_">LogoutSuccessHandler</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onLogoutSuccess</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;æ³¨é”€æˆåŠŸ&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AuthenticationSuccessHandler successHandler;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AuthenticationFailureHandler failureHandler;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> LogoutSuccessHandler logoutSuccessHandler;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.formLogin()</span><br><span class="line"><span class="comment">//                é…ç½®è®¤è¯æˆåŠŸå¤„ç†å™¨</span></span><br><span class="line">                .successHandler(successHandler)</span><br><span class="line"><span class="comment">//                é…ç½®è®¤è¯å¤±è´¥å¤„ç†å™¨</span></span><br><span class="line">                .failureHandler(failureHandler);</span><br><span class="line"></span><br><span class="line">        http.logout()</span><br><span class="line">                <span class="comment">//é…ç½®æ³¨é”€æˆåŠŸå¤„ç†å™¨</span></span><br><span class="line">                .logoutSuccessHandler(logoutSuccessHandler);</span><br><span class="line"></span><br><span class="line">        http.authorizeRequests().anyRequest().authenticated();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>æ–‡ç« ä½œè€…: </span><span class="post-copyright-info"><a href="http://example.com">KNeegcyao</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>æ–‡ç« é“¾æ¥: </span><span class="post-copyright-info"><a href="http://example.com/posts/581c43cc.html">http://example.com/posts/581c43cc.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>ç‰ˆæƒå£°æ˜: </span><span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥æº <a href="http://example.com" target="_blank">KNeegcyao</a>ï¼</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E7%AE%97%E6%B3%95/">ç®—æ³•</a><a class="post-meta__tags" href="/tags/SpringCloud/">SpringCloud</a></div><div class="post-share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/KNeegcyao/picdemo/img/springsecurity-1024x538-1.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>èµåŠ©</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="å¾®ä¿¡"/></a><div class="post-qr-code-desc">å¾®ä¿¡</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="æ”¯ä»˜å®"/></a><div class="post-qr-code-desc">æ”¯ä»˜å®</div></li></ul></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/posts/8b63f587.html" title="DockeråŸºç¡€å…¥é—¨"><img class="cover" src="https://cdn.jsdelivr.net/gh/KNeegcyao/picdemo/img/main_hu47e299bfffaad059de349ef77bc2cb77_42796_1600x0_resize_box_3.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">ä¸Šä¸€ç¯‡</div><div class="info-item-2">DockeråŸºç¡€å…¥é—¨</div></div><div class="info-2"><div class="info-item-1">Dockeræ ¸å¿ƒæ¦‚å¿µDocker å¯ä»¥è®©å¼€å‘è€…æ‰“åŒ…ä»–ä»¬çš„åº”ç”¨ä»¥åŠä¾èµ–åŒ…åˆ°ä¸€ä¸ªè½»é‡çº§ã€å¯ç§»æ¤çš„å®¹å™¨ä¸­ï¼Œç„¶åå‘å¸ƒåˆ°ä»»ä½•æµè¡Œçš„ Linux æœºå™¨ä¸Šï¼Œä¹Ÿå¯ä»¥å®ç°è™šæ‹ŸåŒ–ã€‚ å®¹å™¨æ˜¯å®Œå…¨ä½¿ç”¨æ²™ç®±æœºåˆ¶ï¼Œç›¸äº’ä¹‹é—´ä¸ä¼šæœ‰ä»»ä½•æ¥å£ï¼ˆç±»ä¼¼ iPhone çš„ appï¼‰,æ›´é‡è¦çš„æ˜¯å®¹å™¨æ€§èƒ½å¼€é”€æä½ã€‚ Docker æ˜¯ä¸€ä¸ªç”¨äºå¼€å‘ï¼Œäº¤ä»˜å’Œè¿è¡Œåº”ç”¨ç¨‹åºçš„å¼€æ”¾å¹³å°ã€‚Docker ä½¿æ‚¨èƒ½å¤Ÿå°†åº”ç”¨ç¨‹åºä¸åŸºç¡€æ¶æ„åˆ†å¼€ï¼Œä»è€Œå¯ä»¥å¿«é€Ÿäº¤ä»˜è½¯ä»¶ã€‚å€ŸåŠ© Dockerï¼Œæ‚¨å¯ä»¥ä¸ç®¡ç†åº”ç”¨ç¨‹åºç›¸åŒçš„æ–¹å¼æ¥ç®¡ç†åŸºç¡€æ¶æ„ã€‚é€šè¿‡åˆ©ç”¨ Docker...</div></div></div></a><a class="pagination-related" href="/posts/d2dd85e5.html" title="å¸¸è§æ’åºç®—æ³•æ¯”è¾ƒ"><img class="cover" src="https://cdn.jsdelivr.net/gh/KNeegcyao/picdemo/img/image-20250327104247539.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">ä¸‹ä¸€ç¯‡</div><div class="info-item-2">å¸¸è§æ’åºç®—æ³•æ¯”è¾ƒ</div></div><div class="info-2"><div class="info-item-1">å¸¸è§æ’åºç®—æ³•æ¯”è¾ƒç®—æ³•åˆ†ç±»æ¯”è¾ƒç±»æ’åºï¼š é€šè¿‡å…ƒç´ é—´çš„æ¯”è¾ƒç¡®å®šé¡ºåºï¼Œæ—¶é—´å¤æ‚åº¦ä¸‹é™ä¸º **O(n log n)**ï¼ˆåŸºäºæ¯”è¾ƒå†³ç­–æ ‘æ¨¡å‹ï¼‰ éæ¯”è¾ƒæ’åº: åˆ©ç”¨æ•°æ®ç‰¹å®šå±æ€§ï¼ˆå¦‚æ•´æ•°èŒƒå›´ã€ä½æ•°ï¼‰ï¼Œçªç ´æ¯”è¾ƒæ’åºä¸‹é™ï¼Œæ—¶é—´å¤æ‚åº¦å¯è¾¾åˆ° O(n)     æ’åºæ–¹æ³• å¹³å‡æ—¶é—´å¤æ‚åº¦ æœ€åæ—¶é—´å¤æ‚åº¦ æœ€å¥½æ—¶é—´å¤æ‚åº¦ ç©ºé—´å¤æ‚åº¦ ç¨³å®šæ€§    æ’å…¥æ’åº O(n^2) O(n^2) O(n) O(1) ç¨³å®š   é€‰æ‹©æ’åº O(n^2) O(n^2) O(n^2) O(1) ä¸ç¨³å®š   å†’æ³¡æ’åº O(n^2) O(n^2) O(n) O(1) ç¨³å®š   å¿«é€Ÿæ’åº O(n log n) O(n^2) O(n log n) O(log n) ä¸ç¨³å®š   å½’å¹¶æ’åº O(n log n) O(n log n) O(n log n) O(n) ç¨³å®š   å †æ’åº O(n log n) O(n log n) O(n log n) O(1) ä¸ç¨³å®š   è®¡æ•°æ’åº O(n + k) O(n + k) O(n + k) O(k) ç¨³å®š   æ¡¶æ’åº O(n + k) O(n^2) O(n) O(n +...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>ç›¸å…³æ¨è</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/posts/d2dd85e5.html" title="å¸¸è§æ’åºç®—æ³•æ¯”è¾ƒ"><img class="cover" src="https://cdn.jsdelivr.net/gh/KNeegcyao/picdemo/img/image-20250327104247539.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-03-27</div><div class="info-item-2">å¸¸è§æ’åºç®—æ³•æ¯”è¾ƒ</div></div><div class="info-2"><div class="info-item-1">å¸¸è§æ’åºç®—æ³•æ¯”è¾ƒç®—æ³•åˆ†ç±»æ¯”è¾ƒç±»æ’åºï¼š é€šè¿‡å…ƒç´ é—´çš„æ¯”è¾ƒç¡®å®šé¡ºåºï¼Œæ—¶é—´å¤æ‚åº¦ä¸‹é™ä¸º **O(n log n)**ï¼ˆåŸºäºæ¯”è¾ƒå†³ç­–æ ‘æ¨¡å‹ï¼‰ éæ¯”è¾ƒæ’åº: åˆ©ç”¨æ•°æ®ç‰¹å®šå±æ€§ï¼ˆå¦‚æ•´æ•°èŒƒå›´ã€ä½æ•°ï¼‰ï¼Œçªç ´æ¯”è¾ƒæ’åºä¸‹é™ï¼Œæ—¶é—´å¤æ‚åº¦å¯è¾¾åˆ° O(n)     æ’åºæ–¹æ³• å¹³å‡æ—¶é—´å¤æ‚åº¦ æœ€åæ—¶é—´å¤æ‚åº¦ æœ€å¥½æ—¶é—´å¤æ‚åº¦ ç©ºé—´å¤æ‚åº¦ ç¨³å®šæ€§    æ’å…¥æ’åº O(n^2) O(n^2) O(n) O(1) ç¨³å®š   é€‰æ‹©æ’åº O(n^2) O(n^2) O(n^2) O(1) ä¸ç¨³å®š   å†’æ³¡æ’åº O(n^2) O(n^2) O(n) O(1) ç¨³å®š   å¿«é€Ÿæ’åº O(n log n) O(n^2) O(n log n) O(log n) ä¸ç¨³å®š   å½’å¹¶æ’åº O(n log n) O(n log n) O(n log n) O(n) ç¨³å®š   å †æ’åº O(n log n) O(n log n) O(n log n) O(1) ä¸ç¨³å®š   è®¡æ•°æ’åº O(n + k) O(n + k) O(n + k) O(k) ç¨³å®š   æ¡¶æ’åº O(n + k) O(n^2) O(n) O(n +...</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> è¯„è®º</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="https://cdn.jsdelivr.net/gh/KNeegcyao/picdemo/img/dbec14fc4bb3795ba2556e8a82eaee0f.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">KNeegcyao</div><div class="author-info-description">è®°å½•codingï¼</div><div class="site-data"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">25</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">8</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">6</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/KNeegcyao"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/KNeegcyao" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:zhangchao2903@163.com.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a><a class="social-icon" href="https://music.163.com/#/user/home?id=322815684" target="_blank" title="äº‘éŸ³ä¹"><i class="fa-solid fa-music"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>å…¬å‘Š</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>ç›®å½•</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">ç®€ä»‹</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8"><span class="toc-number">2.</span> <span class="toc-text">å¿«é€Ÿå…¥é—¨</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AE%A4%E8%AF%81"><span class="toc-number">3.</span> <span class="toc-text">è®¤è¯</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%99%BB%E5%BD%95%E6%A0%A1%E9%AA%8C%E6%B5%81%E7%A8%8B"><span class="toc-number">3.1.</span> <span class="toc-text">ç™»å½•æ ¡éªŒæµç¨‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">3.2.</span> <span class="toc-text">åŸç†</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B"><span class="toc-number">3.3.</span> <span class="toc-text">è®¤è¯æµç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%B6%E5%BA%8F%E6%AD%A5%E9%AA%A4%E8%AF%A6%E8%A7%A3"><span class="toc-number">3.3.1.</span> <span class="toc-text">æ—¶åºæ­¥éª¤è¯¦è§£</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BD%A2%E8%B1%A1%E8%A7%A3%E9%87%8A"><span class="toc-number">3.3.2.</span> <span class="toc-text">å½¢è±¡è§£é‡Š</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0"><span class="toc-number">3.4.</span> <span class="toc-text">å…·ä½“å®ç°</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%86%E7%A0%81%E5%8A%A0%E5%AF%86%E5%AD%98%E5%82%A8"><span class="toc-number">3.4.1.</span> <span class="toc-text">å¯†ç åŠ å¯†å­˜å‚¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E7%99%BB%E5%BD%95%E6%8E%A5%E5%8F%A3"><span class="toc-number">3.4.2.</span> <span class="toc-text">å®šä¹‰ç™»å½•æ¥å£</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%A4%E8%AF%81%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-number">3.4.3.</span> <span class="toc-text">è®¤è¯è¿‡æ»¤å™¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E9%94%80"><span class="toc-number">3.4.4.</span> <span class="toc-text">æ³¨é”€</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%8E%88%E6%9D%83"><span class="toc-number">4.</span> <span class="toc-text">æˆæƒ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%94%90-Spring-Security-%E6%8E%88%E6%9D%83%E7%9A%84%E4%B8%89%E7%A7%8D%E5%B8%B8%E8%A7%81%E6%96%B9%E5%BC%8F%EF%BC%9A"><span class="toc-number">4.1.</span> <span class="toc-text">ğŸ” Spring Security æˆæƒçš„ä¸‰ç§å¸¸è§æ–¹å¼ï¼š</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%9C%85-1-%E5%9F%BA%E4%BA%8E-URL-%E7%9A%84%E6%8E%88%E6%9D%83%EF%BC%88%E6%8E%A7%E5%88%B6%E6%8E%A5%E5%8F%A3%E8%AE%BF%E9%97%AE%E6%9D%83%E9%99%90%EF%BC%89"><span class="toc-number">4.1.1.</span> <span class="toc-text">âœ… 1. åŸºäº URL çš„æˆæƒï¼ˆæ§åˆ¶æ¥å£è®¿é—®æƒé™ï¼‰</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%9C%85-2-%E5%9F%BA%E4%BA%8E%E6%96%B9%E6%B3%95%E7%9A%84%E6%8E%88%E6%9D%83%EF%BC%88%E7%B2%BE%E7%BB%86%E6%8E%A7%E5%88%B6%E6%9F%90%E4%B8%AA%E6%8E%A5%E5%8F%A3%E6%88%96%E4%B8%9A%E5%8A%A1%E6%96%B9%E6%B3%95%EF%BC%89"><span class="toc-number">4.1.2.</span> <span class="toc-text">âœ… 2. åŸºäºæ–¹æ³•çš„æˆæƒï¼ˆç²¾ç»†æ§åˆ¶æŸä¸ªæ¥å£æˆ–ä¸šåŠ¡æ–¹æ³•ï¼‰</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%9C%85-3-%E8%87%AA%E5%AE%9A%E4%B9%89%E6%9D%83%E9%99%90%E6%A0%A1%E9%AA%8C%E9%80%BB%E8%BE%91"><span class="toc-number">4.1.3.</span> <span class="toc-text">âœ… 3. è‡ªå®šä¹‰æƒé™æ ¡éªŒé€»è¾‘</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0-1"><span class="toc-number">4.2.</span> <span class="toc-text">å…·ä½“å®ç°</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%99%90%E5%88%B6%E8%AE%BF%E9%97%AE%E8%B5%84%E6%BA%90%E6%89%80%E9%9C%80%E6%9D%83%E9%99%90"><span class="toc-number">4.2.1.</span> <span class="toc-text">é™åˆ¶è®¿é—®èµ„æºæ‰€éœ€æƒé™</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%81%E8%A3%85%E6%9D%83%E9%99%90%E4%BF%A1%E6%81%AF"><span class="toc-number">4.2.2.</span> <span class="toc-text">å°è£…æƒé™ä¿¡æ¯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8E%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9F%A5%E8%AF%A2%E6%9D%83%E9%99%90%E4%BF%A1%E6%81%AF"><span class="toc-number">4.2.3.</span> <span class="toc-text">ä»æ•°æ®åº“æŸ¥è¯¢æƒé™ä¿¡æ¯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0"><span class="toc-number">4.2.4.</span> <span class="toc-text">æ¥å£å…·ä½“å®ç°</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%A4%B1%E8%B4%A5%E5%A4%84%E7%90%86"><span class="toc-number">5.</span> <span class="toc-text">è‡ªå®šä¹‰å¤±è´¥å¤„ç†</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E6%8B%A6%E6%88%AA%E7%82%B9%EF%BC%9AExceptionTranslationFilter"><span class="toc-number">5.1.</span> <span class="toc-text">å¼‚å¸¸æ‹¦æˆªç‚¹ï¼šExceptionTranslationFilter</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%A4%E8%AF%81%E5%A4%B1%E8%B4%A5-vs-%E6%8E%88%E6%9D%83%E5%A4%B1%E8%B4%A5"><span class="toc-number">5.2.</span> <span class="toc-text">è®¤è¯å¤±è´¥ vs æˆæƒå¤±è´¥</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-number">5.3.</span> <span class="toc-text">è‡ªå®šä¹‰å¤„ç†å™¨</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89-AuthenticationEntryPoint"><span class="toc-number">5.3.1.</span> <span class="toc-text">è‡ªå®šä¹‰ AuthenticationEntryPoint</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89-AccessDeniedHandler"><span class="toc-number">5.3.2.</span> <span class="toc-text">è‡ªå®šä¹‰ AccessDeniedHandler</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%86%E8%87%AA%E5%AE%9A%E4%B9%89%E5%A4%84%E7%90%86%E5%99%A8%E6%B3%A8%E5%85%A5%E5%88%B0-Spring-Security"><span class="toc-number">5.4.</span> <span class="toc-text">å°†è‡ªå®šä¹‰å¤„ç†å™¨æ³¨å…¥åˆ° Spring Security</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%B7%A8%E5%9F%9F"><span class="toc-number">6.</span> <span class="toc-text">è·¨åŸŸ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E8%B7%A8%E5%9F%9F%EF%BC%88CORS%EF%BC%89%EF%BC%9F"><span class="toc-number">6.1.</span> <span class="toc-text">ä»€ä¹ˆæ˜¯è·¨åŸŸï¼ˆCORSï¼‰ï¼Ÿ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring-MVC-%E5%B1%82%E9%9D%A2%E5%85%81%E8%AE%B8%E8%B7%A8%E5%9F%9F"><span class="toc-number">6.2.</span> <span class="toc-text">Spring MVC å±‚é¢å…è®¸è·¨åŸŸ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring-Security-%E5%B1%82%E9%9D%A2%E5%85%81%E8%AE%B8%E8%B7%A8%E5%9F%9F"><span class="toc-number">6.3.</span> <span class="toc-text">Spring Security å±‚é¢å…è®¸è·¨åŸŸ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%A4%E5%A4%84%E9%83%BD%E8%A6%81%E9%85%8D%E7%BD%AE%EF%BC%9F"><span class="toc-number">6.4.</span> <span class="toc-text">ä¸ºä»€ä¹ˆä¸¤å¤„éƒ½è¦é…ç½®ï¼Ÿ</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%A4%84%E7%90%86%E5%99%A8-1"><span class="toc-number">7.</span> <span class="toc-text">è‡ªå®šä¹‰å¤„ç†å™¨</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%A4%E8%AF%81%E6%88%90%E5%8A%9F%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-number">7.1.</span> <span class="toc-text">è®¤è¯æˆåŠŸå¤„ç†å™¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%A4%E8%AF%81%E5%A4%B1%E8%B4%A5%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-number">7.2.</span> <span class="toc-text">è®¤è¯å¤±è´¥å¤„ç†å™¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%99%BB%E5%87%BA%E6%88%90%E5%8A%9F%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-number">7.3.</span> <span class="toc-text">ç™»å‡ºæˆåŠŸå¤„ç†å™¨</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>æœ€æ–°æ–‡ç« </span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/8b63f587.html" title="DockeråŸºç¡€å…¥é—¨"><img src="https://cdn.jsdelivr.net/gh/KNeegcyao/picdemo/img/main_hu47e299bfffaad059de349ef77bc2cb77_42796_1600x0_resize_box_3.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="DockeråŸºç¡€å…¥é—¨"/></a><div class="content"><a class="title" href="/posts/8b63f587.html" title="DockeråŸºç¡€å…¥é—¨">DockeråŸºç¡€å…¥é—¨</a><time datetime="2025-05-10T07:44:52.000Z" title="å‘è¡¨äº 2025-05-10 15:44:52">2025-05-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/581c43cc.html" title="SpringSecurityæ¡†æ¶å…¥é—¨"><img src="https://cdn.jsdelivr.net/gh/KNeegcyao/picdemo/img/springsecurity-1024x538-1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="SpringSecurityæ¡†æ¶å…¥é—¨"/></a><div class="content"><a class="title" href="/posts/581c43cc.html" title="SpringSecurityæ¡†æ¶å…¥é—¨">SpringSecurityæ¡†æ¶å…¥é—¨</a><time datetime="2025-04-06T08:19:43.000Z" title="å‘è¡¨äº 2025-04-06 16:19:43">2025-04-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/d2dd85e5.html" title="å¸¸è§æ’åºç®—æ³•æ¯”è¾ƒ"><img src="https://cdn.jsdelivr.net/gh/KNeegcyao/picdemo/img/image-20250327104247539.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="å¸¸è§æ’åºç®—æ³•æ¯”è¾ƒ"/></a><div class="content"><a class="title" href="/posts/d2dd85e5.html" title="å¸¸è§æ’åºç®—æ³•æ¯”è¾ƒ">å¸¸è§æ’åºç®—æ³•æ¯”è¾ƒ</a><time datetime="2025-03-27T06:04:56.000Z" title="å‘è¡¨äº 2025-03-27 14:04:56">2025-03-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/93c6a719.html" title="æ·±å…¥æµ…å‡ºæ¶ˆæ¯é˜Ÿåˆ—(RabbitMQ)"><img src="https://cdn.jsdelivr.net/gh/KNeegcyao/picdemo/img/image.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="æ·±å…¥æµ…å‡ºæ¶ˆæ¯é˜Ÿåˆ—(RabbitMQ)"/></a><div class="content"><a class="title" href="/posts/93c6a719.html" title="æ·±å…¥æµ…å‡ºæ¶ˆæ¯é˜Ÿåˆ—(RabbitMQ)">æ·±å…¥æµ…å‡ºæ¶ˆæ¯é˜Ÿåˆ—(RabbitMQ)</a><time datetime="2025-03-14T14:44:55.000Z" title="å‘è¡¨äº 2025-03-14 22:44:55">2025-03-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/69de8254.html" title="æ‹¦æˆªå™¨Interceptorä¸è¿‡æ»¤å™¨Filter"><img src="https://cdn.jsdelivr.net/gh/KNeegcyao/picdemo/img/4645f616a8feb588fbc802acda2f7c5e.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="æ‹¦æˆªå™¨Interceptorä¸è¿‡æ»¤å™¨Filter"/></a><div class="content"><a class="title" href="/posts/69de8254.html" title="æ‹¦æˆªå™¨Interceptorä¸è¿‡æ»¤å™¨Filter">æ‹¦æˆªå™¨Interceptorä¸è¿‡æ»¤å™¨Filter</a><time datetime="2024-12-25T06:24:59.000Z" title="å‘è¡¨äº 2024-12-25 14:24:59">2024-12-25</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(https://haowallpaper.com/link/common/file/previewFileImg/15918089447001472);"><div id="footer-wrap"><div class="copyright">&copy;2024 - 2025 By KNeegcyao</div><div class="framework-info"><span>æ¡†æ¶ </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>ä¸»é¢˜ </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi, welcome to my <a target="_blank" rel="noopener" href="https://butterfly.js.org/">blog</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="ç®€ç¹è½¬æ¢">ç¹</button><button id="darkmode" type="button" title="æ—¥é—´å’Œå¤œé—´æ¨¡å¼åˆ‡æ¢"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="è®¾ç½®"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="å‰å¾€è¯„è®º"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="/"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script>(() => {
  const panguFn = () => {
    if (typeof pangu === 'object') pangu.autoSpacingPage()
    else {
      btf.getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
        .then(() => {
          pangu.autoSpacingPage()
        })
    }
  }

  const panguInit = () => {
    if (false){
      GLOBAL_CONFIG_SITE.isPost && panguFn()
    } else {
      panguFn()
    }
  }

  btf.addGlobalFn('pjaxComplete', panguInit, 'pangu')
  document.addEventListener('DOMContentLoaded', panguInit)
})()</script><div class="js-pjax"><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.isShuoshuo
  const option = null

  const commentCount = n => {
    const isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
    if (isCommentCount) {
      isCommentCount.textContent= n
    }
  }

  const initGitalk = (el, path) => {
    if (isShuoshuo) {
      window.shuoshuoComment.destroyGitalk = () => {
        if (el.children.length) {
          el.innerHTML = ''
          el.classList.add('no-comment')
        }
      }
    }

    const gitalk = new Gitalk({
      clientID: '',
      clientSecret: '',
      repo: '',
      owner: '',
      admin: [''],
      updateCountCallback: commentCount,
      ...option,
      id: isShuoshuo ? path : (option && option.id) || 'd39b8f3a64aaacca80140bd15af438b0'
    })

    gitalk.render('gitalk-container')
  }

  const loadGitalk = async(el, path) => {
    if (typeof Gitalk === 'function') initGitalk(el, path)
    else {
      await btf.getCSS('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css')
      await btf.getScript('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js')
      initGitalk(el, path)
    }
  }

  if (isShuoshuo) {
    'Gitalk' === 'Gitalk'
      ? window.shuoshuoComment = { loadComment: loadGitalk }
      : window.loadOtherComment = loadGitalk
    return
  }

  if ('Gitalk' === 'Gitalk' || !false) {
    if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
    else loadGitalk()
  } else {
    window.loadOtherComment = loadGitalk
  }
})()</script></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.8" zIndex="-1" count="200" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-show-text.min.js" data-mobile="true" data-text="Java,Spring,k8s,MVC,Redis,Mysql,JVM,Maven,Docker" data-fontsize="15px" data-random="true" async="async"></script><script>(() => {
  const isChatBtn = false
  const isChatHideShow = false

  if (isChatBtn) {
    const close = () => {
      Chatra('minimizeWidget')
      Chatra('hide')
    }

    const open = () => {
      Chatra('openChat', true)
      Chatra('show')
    }

    window.ChatraSetup = { startHidden: true }
  
    window.chatBtnFn = () => {
      document.getElementById('chatra').classList.contains('chatra--expanded') ? close() : open()
    }
  } else if (isChatHideShow) {
    window.chatBtn = {
      hide: () => Chatra('hide'),
      show: () => Chatra('show')
    }
  }

  (function(d, w, c) {
    w.ChatraID = ''
    var s = d.createElement('script')
    w[c] = w[c] || function() {
      (w[c].q = w[c].q || []).push(arguments)
    }
    s.async = true
    s.src = 'https://call.chatra.io/chatra.js'
    if (d.head) d.head.appendChild(s)
  })(document, window, 'Chatra')
})()</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>